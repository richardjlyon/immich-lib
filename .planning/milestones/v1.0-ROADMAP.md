# Milestone v1.0: MVP

**Status:** SHIPPED 2025-12-27
**Phases:** 1-7
**Total Plans:** 23

## Overview

Build a Rust library for the Immich API focused on duplicate management, paired with a binary tool that prioritizes metadata completeness over file size when selecting which duplicate to keep. The journey goes from API client foundation through duplicate discovery, metadata scoring, analysis output, and finally safe execution with backups.

## Phases

### Phase 1: Foundation

**Goal**: Set up Rust project structure with working Immich API client and authentication
**Depends on**: Nothing (first phase)
**Plans**: 2 plans
**Completed**: 2025-12-26

Plans:
- [x] 01-01: Project Structure & Types (3 tasks, autonomous)
- [x] 01-02: HTTP Client & Authentication (2 tasks, has checkpoint)

**Details:**
- Rust 2024 edition workspace with typed errors and serde API models
- ImmichClient authenticates via x-api-key and fetches duplicates
- 30-second timeout, url::Url type for proper URL handling

### Phase 2: Duplicate Discovery

**Goal**: Fetch duplicate groups from Immich and retrieve asset metadata for comparison
**Depends on**: Phase 1
**Plans**: 1 plan
**Completed**: 2025-12-26

Plans:
- [x] 02-01: Data Model Completion (2 tasks, autonomous)

**Details:**
- Complete AssetResponse and ExifInfo types with metadata accessor methods
- serde(default) for optional fields, graceful handling of missing API data
- has_gps() requires both coords, has_camera_info() either make or model

### Phase 3: Metadata Scoring

**Goal**: Implement scoring algorithm that ranks assets by metadata completeness
**Depends on**: Phase 2
**Plans**: 1 plan
**Completed**: 2025-12-26

Plans:
- [x] 03-01: Metadata Scoring Algorithm (3 tasks, autonomous)

**Details:**
- Weighted scoring for GPS, timezone, camera, lens fields
- GPS conflict threshold 0.0001 deg (~11m tolerance)
- String normalization lowercase+trim for conflict detection
- Serde tag format for clean JSON output

### Phase 4: Analysis Stage

**Goal**: Build the analyze CLI command that outputs scored duplicate groups to JSON
**Depends on**: Phase 3
**Plans**: 1 plan
**Completed**: 2025-12-26

Plans:
- [x] 04-01: Analyze Command (3 tasks, autonomous)

**Details:**
- AnalysisReport includes needs_review_count for quick filtering
- total_assets = winner + losers for full asset count per group
- Conditional conflict message in console output

### Phase 5: Execution Stage

**Goal**: Build the execute command that downloads backups and deletes duplicates
**Depends on**: Phase 4
**Plans**: 4 plans
**Completed**: 2025-12-26

Plans:
- [x] 05-01: API Client Extensions (3 tasks, autonomous)
- [x] 05-02: Executor Module (3 tasks, autonomous)
- [x] 05-03: Execute CLI Command (2 tasks + checkpoint, interactive)
- [x] 05-04: Winner Selection Fix (3 tasks, autonomous)

**Details:**
- Streaming downloads with bytes_stream() for large files
- governor GCRA for rate limiting, two-phase download-then-delete
- Asset ID prefix in filenames prevents collision
- Winner = largest dimensions (user clarification mid-phase)
- Metadata consolidation fetches and transfers GPS/timezone

### Phase 6: Synthetic Integration Tests

**Goal**: Comprehensive integration tests using generated images in isolated Docker environment
**Depends on**: Phase 5
**Plans**: 11 plans
**Completed**: 2025-12-27

Plans:
- [x] 06-01: Test Candidate Finder
- [x] 06-02: Review & Refine Test Matrix
- [x] 06-03: Test Image Generator
- [x] 06-03.1: Real Image Fixture Refactor (INSERTED)
- [x] 06-04: Docker Test Environment
- [x] 06-05-01: Test Harness
- [x] 06-05-02: Winner/Consolidation Tests
- [x] 06-05.2: Unique Base Images (INSERTED)
- [x] 06-05-03: Edge Case Tests (pivoted to recorded fixtures)

**Details:**
- Pivoted from live Docker tests to recorded fixture tests
- 24 unit tests covering W1-W8, C1-C8, F1-F7, X1-X11 scenarios
- Tests run in 0.01s vs ~5 minutes with Docker
- Real Immich API responses guarantee mock data accuracy

### Phase 7: Live Instance Validation

**Goal**: Validate against real duplicates in cloned instance before production use
**Depends on**: Phase 6
**Plans**: 3 plans
**Completed**: 2025-12-27

Plans:
- [x] 07-01: Validation Runner
- [x] 07-02: End-State Verification
- [x] 07-03: Restore Command

**Details:**
- Full analyze -> execute workflow validated against Docker Immich
- GPS consolidation verified: 3/3 transfers successful
- Dimension-based winner selection: 31/31 groups correct
- All backup files downloaded: 43/43
- Restore command for re-uploading backed-up files
- Documented Immich API limitation: camera make/model read-only

---

## Milestone Summary

**Decimal Phases:**
- Phase 06-03.1: Real Image Fixture Refactor (inserted for CLIP compatibility)
- Phase 06-05.2: Unique Base Images (inserted for scenario isolation)

**Key Decisions:**

| Decision | Rationale |
|----------|-----------|
| Trust Immich duplicate detection | Their detection works, only selection logic is broken |
| Metadata completeness priority | GPS, timezone, camera info matter more than file size |
| Two-stage workflow | Allows review without 2000 manual confirmations |
| Download originals for backup | Full recovery possible, not dependent on Immich trash |
| Winner = largest dimensions | Keep best quality, transfer metadata from other files |
| Pivot to recorded fixtures | Live Docker tests tested Immich's CLIP, not our code |

**Issues Resolved:**
- Winner selection logic corrected (Phase 5 mid-course correction)
- CLIP grouping issues with shared base images (unique images per scenario)
- Integration test scope clarified (test our code, not Immich's CLIP)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None significant

---

_For current project status, see .planning/ROADMAP.md_
