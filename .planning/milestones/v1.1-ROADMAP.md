# Milestone v1.1: iPhone Letterbox Duplicates

**Status:** ✅ SHIPPED 2025-12-28
**Phases:** 8-10
**Total Plans:** 5

## Overview

Detect and remove iPhone 4:3/16:9 crop duplicates - pairs where one is the full 4:3 sensor capture and one is a 16:9 crop of the same moment. Uses timestamp + camera matching for detection (Live Photo Video Index not exposed by Immich API). Selection always keeps 4:3 (more pixels, complete scene).

## Phases

### Phase 8: Research

**Goal**: Investigate iPhone EXIF patterns and metadata signals for crop pairs
**Depends on**: v1.0 complete
**Plans**: 1 plan

Plans:
- [x] 08-01: Document iPhone 16:9 crop patterns

**Details:**
- Discovered iPhone saves both 4:3 full sensor and 16:9 crops as separate files
- Verified `Live Photo Video Index` links pairs but NOT exposed by Immich API
- Designed fallback: timestamp + make + model + GPS matching
- Confirmed no pixel analysis needed - pure metadata detection
- Selection: 4:3 always wins (more pixels, full scene)

### Phase 9: Detection + Selection

**Goal**: Find candidate pairs and select keeper using timestamp + camera matching
**Depends on**: Phase 8 (research findings)
**Plans**: 2 plans

Plans:
- [x] 09-01: Letterbox Module Core (AspectRatio, LetterboxPair, pairing algorithm)
- [x] 09-02: Analysis Report (LetterboxAnalysis, ImmichClient integration)

**Details:**
- Created AspectRatio enum with orientation-agnostic detection (4:3 = 1.33, 16:9 = 1.78)
- Implemented PairingKey grouping by timestamp + make + model + optional GPS
- LetterboxPair struct with keeper (4:3) and delete (16:9) fields
- find_letterbox_pairs() filters to iPhone only, skips ambiguous groups
- LetterboxAnalysis report with summary stats (pairs found, space recoverable)
- get_all_assets() paginated fetching (1000 per page)
- 25 unit tests covering all edge cases

### Phase 10: CLI Command

**Goal**: Implement `letterbox` subcommand with analyze/execute/verify workflow
**Depends on**: Phase 9
**Plans**: 2 plans

Plans:
- [x] 10-01: Analyze + Verify (letterbox analyze, letterbox verify commands)
- [x] 10-02: Execute (letterbox execute with backup-before-delete)

**Details:**
- `letterbox analyze [--output FILE]` - scans all assets for iPhone 4:3/16:9 pairs
- `letterbox execute --input FILE --backup-dir DIR` - downloads 16:9 crops, then deletes
- `letterbox verify --input FILE` - validates keepers present, deletes removed
- Rate limiting via governor GCRA to prevent API overload
- Execution report JSON written to backup directory
- Failed downloads skip deletion to prevent data loss

---

## Milestone Summary

**Key Decisions:**

| Phase | Decision | Rationale |
|-------|----------|-----------|
| 08-01 | Timestamp+camera pairing | Live Photo Video Index not exposed by Immich API |
| 08-01 | 4:3 always wins selection | More pixels, complete scene, can crop later |
| 08-01 | No pixel analysis needed | Detection purely metadata-based via Immich API |
| 08-01 | Consolidate to 3 phases | Original 4 phases → 3 (eliminated pixel analysis) |
| 09-01 | Orientation-agnostic ratio | Use max/min dims to handle portrait/landscape |
| 09-01 | PairingKey grouping | timestamp_second + make + model + GPS optional |
| 09-02 | 1000 page size for pagination | Standard Immich default for asset listing |
| 09-02 | Track skipped counts | Transparency for non-iPhone and ambiguous groups |

**Issues Resolved:**

- Live Photo Video Index not exposed by API - designed robust fallback using timestamp + camera matching
- Portrait/landscape handling - use max/min dimensions for orientation-agnostic ratio detection
- Ambiguous group handling - skip groups with multiple 4:3 or multiple 16:9 at same timestamp

**Issues Deferred:**

None

**Technical Debt Incurred:**

None - clean implementation following established patterns

---

_For current project status, see .planning/ROADMAP.md_
