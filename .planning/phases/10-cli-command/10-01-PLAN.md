---
phase: 10-cli-command
plan: 01
type: execute
---

<objective>
Implement `letterbox analyze` and `letterbox verify` CLI subcommands.

Purpose: Enable users to detect iPhone 4:3/16:9 letterbox pairs and verify post-execution state.
Output: Two new subcommands under `letterbox` parent command with JSON output support.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-research/DISCOVERY.md
@.planning/phases/09-detection/09-01-SUMMARY.md
@.planning/phases/09-detection/09-02-SUMMARY.md
@src/bin/immich-dupes.rs
@src/letterbox.rs

**Prior decisions affecting this phase:**
- Phase 09: LetterboxAnalysis struct with from_assets(), delete_ids(), keeper_ids() methods
- Phase 09: ImmichClient.get_all_assets() with pagination support
- Phase 09: All letterbox types exported from lib.rs public API

**Patterns to follow:**
- Existing `Commands` enum structure with subcommands
- Same CLI argument patterns (--output, --format, --input)
- Same error handling with anyhow::Context
- Same JSON serialization with serde_json::to_writer_pretty
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Letterbox subcommand with analyze</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
Add a `Letterbox` variant to the `Commands` enum with nested subcommands:

```rust
/// Letterbox duplicate management (iPhone 4:3/16:9 pairs)
Letterbox {
    #[command(subcommand)]
    command: LetterboxCommands,
},
```

Create `LetterboxCommands` enum with `Analyze` variant:

```rust
#[derive(Subcommand, Debug)]
enum LetterboxCommands {
    /// Analyze all assets for letterbox pairs and output results to JSON
    Analyze {
        /// Output file path for JSON results
        #[arg(short, long)]
        output: PathBuf,
    },
}
```

Add match arm in main() to handle `Commands::Letterbox { command }`.

Implement `run_letterbox_analyze(url, api_key, output)`:
1. Create ImmichClient
2. Call `client.get_all_assets().await` to fetch all assets
3. Call `LetterboxAnalysis::from_assets(&assets)`
4. Write JSON to output file with serde_json::to_writer_pretty
5. Print summary: pairs found, space recoverable, skipped counts

Import `LetterboxAnalysis` from `immich_lib`.
  </action>
  <verify>
cargo clippy -- -D warnings passes
cargo build --release succeeds
./target/release/immich-dupes letterbox --help shows analyze subcommand
  </verify>
  <done>
`letterbox analyze --output` command works and outputs valid JSON with pairs, statistics
  </done>
</task>

<task type="auto">
  <name>Task 2: Add letterbox verify subcommand</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
Add `Verify` variant to `LetterboxCommands`:

```rust
/// Verify post-execution state: check keepers exist, deletes removed
Verify {
    /// Path to the letterbox analysis JSON that was used for execution
    analysis_json: PathBuf,

    /// Output format (text or json)
    #[arg(long, default_value = "text")]
    format: String,
},
```

Create `LetterboxVerificationReport` struct (similar to existing `VerificationReport`):
- verified_at: DateTime<Utc>
- server_url: String
- pairs_verified: usize
- keepers_present: usize
- keepers_missing: usize
- deletes_removed: usize (404 or trashed)
- deletes_still_present: usize
- pairs: Vec<LetterboxPairVerification>
- anomalies: Vec<String>

Create `LetterboxPairVerification` struct:
- timestamp: String
- keeper_status: AssetStatus (reuse existing)
- delete_status: AssetStatus

Implement `run_letterbox_verify(url, api_key, analysis_json, format)`:
1. Load LetterboxAnalysis from JSON file
2. For each pair:
   - Check keeper exists via client.get_asset()
   - Check delete is gone (404) or trashed
3. Build LetterboxVerificationReport
4. Output as text or JSON based on format flag

Text output format:
```
Letterbox Verification Report
=============================

Pairs verified:        N
Keepers present:       N/N
Keepers missing:       N
Deletes removed:       N
Deletes still present: N

[Anomalies if any]

VERIFICATION PASSED/FAILED
```
  </action>
  <verify>
cargo clippy -- -D warnings passes
cargo build --release succeeds
./target/release/immich-dupes letterbox verify --help shows options
  </verify>
  <done>
`letterbox verify` command validates keepers exist and deletes are gone, outputs text/json report
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo clippy -- -D warnings` passes with no warnings
- [ ] `cargo build --release` succeeds
- [ ] `cargo test` passes (existing tests still work)
- [ ] `./target/release/immich-dupes letterbox --help` shows both subcommands
- [ ] `./target/release/immich-dupes letterbox analyze --help` shows --output option
- [ ] `./target/release/immich-dupes letterbox verify --help` shows analysis_json and --format options
</verification>

<success_criteria>
- Both `letterbox analyze` and `letterbox verify` subcommands implemented
- Analyze outputs valid JSON matching LetterboxAnalysis structure
- Verify checks keeper/delete status and reports results
- All clippy warnings resolved
- Existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-cli-command/10-01-SUMMARY.md`
</output>
