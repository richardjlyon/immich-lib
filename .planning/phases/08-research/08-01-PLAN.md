---
phase: 08-research
plan: 01
type: execute
---

<objective>
Document iPhone 16:9 crop duplicate patterns discovered through sample analysis.

Purpose: Establish the detection and pairing strategy for iPhone-generated duplicate pairs where one is the 4:3 original and one is a 16:9 crop.
Output: DISCOVERY.md with verified patterns, pairing signals, and selection criteria.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Sample Analysis Results:**
Examined pair from user's Immich instance:
- IMG_3460.HEIC (keeper): 5712x4284 (4:3), 24.5 MP
- 241223-iPhone 15 Pro Max-923.HEIC: 5712x3213 (16:9), 18.4 MP

**Key Discovery - Pairing Signal:**
`Live Photo Video Index: 8595185700` - IDENTICAL on both images!

**Key Discovery - Selection Criteria:**
- NOT actual letterboxing (no black bars)
- 16:9 version is a CROP of the 4:3 original
- Keep 4:3 version (more pixels, full sensor capture)

**Key Discovery - Metadata Patterns:**
- Timestamps identical to millisecond
- GPS, camera info identical on both
- Different `Media Group UUID`
- `Exif Image Height` claims original 4284 on both, but actual differs

**HEIC Constraint:**
HEIC manipulation in Rust is problematic - detection should rely on EXIF metadata via Immich API, not pixel analysis.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DISCOVERY.md with findings</name>
  <files>.planning/phases/08-research/DISCOVERY.md</files>
  <action>
Document the research findings in structured format:

1. Problem Statement - iPhone creates 4:3 + 16:9 pairs, both imported to Immich
2. Pairing Strategy - Use `Live Photo Video Index` EXIF field (available via Immich API)
3. Selection Strategy - Keep 4:3 (larger pixel count, original sensor capture)
4. Implementation Notes:
   - No pixel analysis needed (avoids HEIC complexity)
   - Query Immich for assets with matching Live Photo Video Index
   - Compare dimensions to identify 4:3 vs 16:9 variants
5. Edge Cases to Consider:
   - Images without Live Photo Video Index
   - Non-iPhone images
   - Already-processed pairs
6. API Requirements - What Immich API fields are needed

Use the sample analysis data from context section.
  </action>
  <verify>DISCOVERY.md exists and contains all sections</verify>
  <done>Structured research document ready for implementation planning</done>
</task>

<task type="auto">
  <name>Task 2: Verify Immich API provides Live Photo Video Index</name>
  <files>.planning/phases/08-research/DISCOVERY.md</files>
  <action>
Check if Immich API exposes `Live Photo Video Index` (or equivalent) in asset metadata:

1. Review existing immich-lib code for EXIF field handling
2. Check Immich API documentation for available EXIF fields
3. If not directly available, document alternative pairing strategies:
   - Timestamp matching (within 1 second)
   - Same camera + same timestamp
   - Filename pattern matching
4. Update DISCOVERY.md with API findings and recommended approach
  </action>
  <verify>DISCOVERY.md updated with API availability status</verify>
  <done>Clear understanding of what Immich API exposes for pairing</done>
</task>

<task type="auto">
  <name>Task 3: Document revised milestone scope</name>
  <files>.planning/phases/08-research/DISCOVERY.md</files>
  <action>
Based on discoveries, the original v1.1 phases may need adjustment:

Original plan assumed:
- Phase 9: Detection via timestamp + iPhone ID
- Phase 10: Pixel analysis for black bar detection
- Phase 11: CLI command

Revised understanding:
- No pixel analysis needed (simpler!)
- Detection via Live Photo Video Index (or timestamp fallback)
- Selection via dimension comparison

Document in DISCOVERY.md:
1. Recommended phase consolidation (if any)
2. Simplified implementation approach
3. Risk assessment - what if Live Photo Video Index isn't available via API?
  </action>
  <verify>DISCOVERY.md has implementation recommendations section</verify>
  <done>Clear path forward for implementation phases</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] DISCOVERY.md created with all findings
- [ ] API availability for pairing signal verified
- [ ] Implementation approach documented
- [ ] Edge cases identified
</verification>

<success_criteria>
- DISCOVERY.md provides clear answers for:
  - How to pair 4:3/16:9 variants
  - How to select the keeper
  - What API fields are required
- Implementation phases can proceed with confidence
</success_criteria>

<output>
After completion, create `.planning/phases/08-research/08-01-SUMMARY.md`:

# Phase 8 Plan 1: Research Summary

**[One-liner about key discoveries]**

## Accomplishments
- [Key findings documented]

## Files Created/Modified
- `.planning/phases/08-research/DISCOVERY.md`

## Decisions Made
- [Pairing strategy decision]
- [Selection strategy decision]

## Issues Encountered
- [Any blockers or concerns]

## Next Step
Ready for Phase 9 planning (or consolidated implementation)
</output>
