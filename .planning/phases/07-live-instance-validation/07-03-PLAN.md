---
phase: 07-live-instance-validation
plan: 03
type: execute
---

<objective>
Add restore command to re-upload backed-up files to Immich.

Purpose: Provide tested escape hatch before running on production - if something goes wrong, the tool can undo what it did.
Output: Working `restore` CLI command that uploads files from backup directory to Immich as new assets.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-live-instance-validation/07-CONTEXT.md
@.planning/phases/07-live-instance-validation/07-01-SUMMARY.md
@.planning/phases/07-live-instance-validation/07-02-SUMMARY.md

**Prior decisions affecting this phase:**
- Backup files stored with asset ID prefix in filename
- Execute command creates backup directory with downloaded originals
- Full recovery = new assets, not original IDs

**From 07-CONTEXT.md:**
> Restore command re-uploads from backup directory created by execute
> Having restore built into the tool provides simpler recovery path

**Relevant source files:**
@src/bin/immich-dupes.rs
@src/client.rs
@tests/docker/validation-backups/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add upload_asset method to client</name>
  <files>src/client.rs</files>
  <action>
Add method to ImmichClient for uploading assets:

```rust
pub async fn upload_asset(&self, file_path: &Path) -> Result<AssetResponse>
```

Implementation:
1. Read file from disk
2. Extract original filename from path (strip asset ID prefix if present)
3. Use multipart form upload to POST /assets
4. Return the created asset info

The Immich upload endpoint expects:
- `assetData`: file content (multipart)
- `deviceAssetId`: unique identifier (use filename or generate UUID)
- `deviceId`: device identifier (use "immich-dupes-restore")
- `fileCreatedAt`: file creation time (use file mtime or now)
- `fileModifiedAt`: file modification time (use file mtime or now)

Handle errors for: file not found, upload failed, API errors.
  </action>
  <verify>`cargo build` succeeds, no clippy warnings</verify>
  <done>upload_asset method added to ImmichClient</done>
</task>

<task type="auto">
  <name>Task 2: Add restore CLI command</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
Add `restore` subcommand to the CLI:

1. Add RestoreArgs to Commands enum:
   - backup_dir: Path to backup directory (required)
   - dry_run: bool - list files without uploading (optional, default false)

2. Implement restore logic:
   - Scan backup_dir for image/video files
   - For each file:
     a. If dry_run: print "Would restore: {filename}"
     b. Else: call client.upload_asset(path)
   - Track success/failure counts
   - Print summary: "Restored X files, Y failures"

3. Handle the execution report JSON in backup dir:
   - Skip non-media files (*.json, *.txt)
   - Or explicitly filter to known image/video extensions

Output format:
```
Restoring from: /path/to/backups
Found 43 files to restore

[1/43] Uploading abc123_IMG_001.jpg... OK
[2/43] Uploading def456_IMG_002.jpg... OK
...

Restore complete: 43 uploaded, 0 failed
```
  </action>
  <verify>`cargo build` succeeds, `./target/debug/immich-dupes restore --help` shows options</verify>
  <done>restore command added with dry-run and upload functionality</done>
</task>

<task type="auto">
  <name>Task 3: Test restore against Docker instance</name>
  <files>tests/docker/test-restore.sh</files>
  <action>
Create test script and run restore to validate:

1. Create tests/docker/test-restore.sh:
   - Source environment variables
   - Run dry-run first: `immich-dupes restore --backup-dir validation-backups --dry-run`
   - Count files in backup dir
   - Actually run restore (uploads to Immich)
   - Query Immich API to confirm new assets exist

2. Execute the test:
   - Ensure Docker Immich is running
   - Run the test script
   - Verify files were uploaded

3. Capture results showing:
   - Number of files in backup dir
   - Number successfully uploaded
   - Confirmation they appear in Immich

Note: This creates duplicate assets in the test instance (originals + restored copies). That's expected for this test.
  </action>
  <verify>
- Script exists: `ls tests/docker/test-restore.sh`
- Script ran successfully
- Immich shows restored assets (query via API or check web UI)
  </verify>
  <done>Restore command tested, files successfully uploaded to Immich</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] upload_asset method implemented in client.rs
- [ ] restore CLI command works with --dry-run
- [ ] restore CLI command uploads files to Immich
- [ ] `cargo clippy -- -D warnings` passes
- [ ] Test script validates restore functionality
</verification>

<success_criteria>
- restore command uploads backup files to Immich
- Dry-run mode works for preview
- Files appear as new assets in Immich after restore
- Provides tested escape hatch for production use
</success_criteria>

<output>
After completion, create `.planning/phases/07-live-instance-validation/07-03-SUMMARY.md`:

# Phase 7 Plan 3: Restore Command Summary

**[One-liner about restore functionality]**

## Accomplishments
- upload_asset client method added
- restore CLI command implemented
- Tested against Docker Immich

## Files Created/Modified
- src/client.rs - Added upload_asset method
- src/bin/immich-dupes.rs - Added restore command
- tests/docker/test-restore.sh - Restore test script

## Test Results
- Files in backup: X
- Successfully restored: X
- Confirmed in Immich: X

## Issues Encountered
[Any issues]

## Phase Complete
Phase 7 complete. Tool has full workflow + restore capability.
Ready for production consideration.
</output>
