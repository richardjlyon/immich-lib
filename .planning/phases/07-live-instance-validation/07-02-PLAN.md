---
phase: 07-live-instance-validation
plan: 02
type: execute
---

<objective>
Build verification tool and validate end-state of executed workflow.

Purpose: Prove that metadata consolidation actually worked and no data was lost during execution.
Output: Verification report confirming winners have expected metadata, losers are gone, and backups are valid.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-live-instance-validation/07-CONTEXT.md
@.planning/phases/07-live-instance-validation/07-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Winner = largest dimensions (Phase 5 decision)
- Consolidation transfers GPS, datetime, description from losers to winner
- Test fixtures have known scenarios (W1-W8, C1-C8, etc.)

**What 07-01 produced:**
- Executed workflow against Docker instance
- Backup files in tests/docker/validation-backups/
- Modified Immich database state

**Relevant source files:**
@src/bin/immich-dupes.rs
@src/client.rs
@tests/docker/validation-analysis.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add verify CLI command</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
Add a `verify` subcommand that checks the post-execution state:

1. Add VerifyArgs struct with:
   - analysis_json: Path to the analysis JSON used for execution
   - Output format option (text/json)

2. Implement verify command that:
   - Loads the analysis JSON to get expected winners and losers
   - For each group:
     a. Fetches winner asset from Immich API
     b. Checks winner still exists (not deleted by mistake)
     c. Checks winner has expected metadata (GPS if consolidation was needed)
     d. Attempts to fetch each loser - should return 404/not found
   - Reports: winners verified, losers confirmed deleted, consolidation status

3. Output summary:
   - Groups verified: X
   - Winners present: X/Y
   - Losers deleted: X/Y
   - Consolidation successful: X/Y (where applicable)
   - Any anomalies found
  </action>
  <verify>`cargo build` succeeds, `./target/debug/immich-dupes verify --help` shows options</verify>
  <done>verify command added with winner/loser/consolidation checking</done>
</task>

<task type="auto">
  <name>Task 2: Run verification against Docker instance</name>
  <files>tests/docker/verification-report.txt</files>
  <action>
Execute the verify command against the post-execution Docker state:

1. Ensure Docker Immich is still running (from 07-01)
2. Run: `./target/debug/immich-dupes -u $IMMICH_URL -a $IMMICH_API_KEY verify tests/docker/validation-analysis.json`
3. Capture output to tests/docker/verification-report.txt
4. Check for any failures or anomalies

Expected outcomes:
- All winners still exist in Immich
- All losers return "not found" (deleted)
- Consolidation metadata present on winners that needed it
  </action>
  <verify>
- Verification ran: `cat tests/docker/verification-report.txt`
- No anomalies reported in output
  </verify>
  <done>Verification complete, all checks passed</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Verification tool and end-state validation of executed workflow</what-built>
  <how-to-verify>
    1. Review tests/docker/verification-report.txt
    2. Confirm all winners are present
    3. Confirm all losers are deleted
    4. Check consolidation results (metadata transferred where needed)
    5. Optionally: Use Immich web UI to spot-check a few surviving images have correct metadata
  </how-to-verify>
  <resume-signal>Type "approved" if validation passes, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] verify CLI command implemented
- [ ] `cargo clippy -- -D warnings` passes
- [ ] Verification ran against Docker instance
- [ ] All winners confirmed present
- [ ] All losers confirmed deleted
- [ ] Consolidation metadata verified
</verification>

<success_criteria>
- verify command works correctly
- All duplicate groups validated
- Zero data loss confirmed
- Consolidation proved working against real Immich API
- Phase 7 complete - tool validated for production consideration
</success_criteria>

<output>
After completion, create `.planning/phases/07-live-instance-validation/07-02-SUMMARY.md`:

# Phase 7 Plan 2: End-State Verification Summary

**[One-liner about verification results]**

## Accomplishments
- verify CLI command implemented
- Post-execution state validated
- [Consolidation results]

## Verification Results
- Groups checked: X
- Winners present: X/X
- Losers deleted: X/X
- Consolidation successful: X/Y

## Files Created/Modified
- src/bin/immich-dupes.rs - Added verify command
- tests/docker/verification-report.txt - Verification output

## Issues Encountered
[Any anomalies or issues found]

## Phase Complete
Phase 7 complete. Tool validated against live Immich instance.
Ready for production consideration.
</output>
