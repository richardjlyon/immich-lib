---
phase: 05-execution-stage
plan: 04
type: fix
---

<objective>
Fix winner selection to keep the largest file (best quality) and consolidate metadata before deletion.

Purpose: Correct requirements misunderstanding - the tool should keep the highest quality file and transfer metadata from duplicates, not keep the metadata-rich file.
Output: Winner = largest dimensions (then file size), with metadata consolidated from losers before deletion.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-execution-stage/05-RESEARCH.md
@.planning/phases/05-execution-stage/05-03-SUMMARY.md

**Problem discovered in 05-03 checkpoint:**
- Current: Keeps file with highest metadata score (smaller file with GPS)
- Required: Keep largest file (best quality), transfer metadata to it

**From research (05-RESEARCH.md):**
- API can update: latitude, longitude, dateTimeOriginal, description, rating
- API CANNOT update: camera make/model, lens info, exposure settings

@src/scoring.rs
@src/client.rs
@src/executor.rs
@src/models/exif.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Change winner selection to largest dimensions</name>
  <files>src/scoring.rs</files>
  <action>
Modify `DuplicateAnalysis::from_group()` to select winner by:

1. Primary: Largest dimensions (width × height pixels)
   - Use `exif_image_width` and `exif_image_height` from ExifInfo
   - If dimensions missing, treat as 0

2. Secondary: Largest file size (tiebreaker)
   - Use `file_size_in_byte` from ExifInfo

3. Tertiary: First in list (stable sort)

Update ScoredAsset to include dimensions:
```rust
pub struct ScoredAsset {
    pub asset_id: String,
    pub filename: String,
    pub score: MetadataScore,  // Still needed for consolidation decisions
    pub file_size: Option<u64>,
    pub dimensions: Option<(u32, u32)>,  // (width, height)
}
```

The metadata score is still calculated and stored - it's used to identify which assets have metadata worth consolidating, not for winner selection.
  </action>
  <verify>cargo build && cargo test</verify>
  <done>Winner is largest file by dimensions, metadata score still tracked</done>
</task>

<task type="auto">
  <name>Task 2: Add update_asset_metadata to ImmichClient</name>
  <files>src/client.rs</files>
  <action>
Add method to update asset metadata via PUT /assets/{id}:

```rust
pub async fn update_asset_metadata(
    &self,
    asset_id: &str,
    latitude: Option<f64>,
    longitude: Option<f64>,
    date_time_original: Option<&str>,
    description: Option<&str>,
) -> Result<()>
```

Only include fields that are Some - use skip_serializing_if.

Reference: 05-RESEARCH.md has the implementation pattern.
  </action>
  <verify>cargo build succeeds</verify>
  <done>Client can update asset metadata</done>
</task>

<task type="auto">
  <name>Task 3: Add metadata consolidation to executor</name>
  <files>src/executor.rs, src/models/execution.rs</files>
  <action>
Before deleting losers, consolidate metadata to winner:

1. In `execute_group()`, after identifying winner:
   - Check if winner lacks GPS but any loser has it → copy GPS
   - Check if winner lacks dateTimeOriginal but any loser has it → copy
   - Check if winner lacks description but any loser has it → copy

2. Call `update_asset_metadata()` if any consolidation needed

3. Update GroupResult to track consolidation:
```rust
pub struct GroupResult {
    // ... existing fields ...
    pub consolidation_result: Option<ConsolidationResult>,
}

pub struct ConsolidationResult {
    pub gps_transferred: bool,
    pub datetime_transferred: bool,
    pub description_transferred: bool,
    pub source_asset_id: String,
}
```

4. Note: This requires fetching full asset data for losers to get EXIF values.
   The ScoredAsset only has scores, not actual values.
   Options:
   a) Fetch asset data during execution (adds API calls)
   b) Store EXIF values in analysis JSON (larger JSON, but no extra calls)

   Recommend option (a) for simplicity - fetch during execution.
  </action>
  <verify>cargo clippy -- -D warnings</verify>
  <done>Metadata consolidated before deletion</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds
- [ ] `cargo clippy -- -D warnings` passes
- [ ] `cargo test` passes
- [ ] Winner is largest by dimensions, then file size
- [ ] Metadata score still calculated (for consolidation decisions)
- [ ] GPS/datetime/description consolidated before deletion
</verification>

<success_criteria>
- Winner selection based on dimensions → file size
- Metadata consolidated from losers to winner before deletion
- No metadata loss for consolidatable fields (GPS, datetime, description)
- Unconsolidatable fields (camera info) flagged in conflicts
</success_criteria>

<output>
After completion, create `.planning/phases/05-execution-stage/05-04-SUMMARY.md`
</output>
