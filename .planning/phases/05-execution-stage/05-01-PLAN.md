---
phase: 05-execution-stage
plan: 01
type: execute
---

<objective>
Extend ImmichClient with download, delete, and metadata update methods.

Purpose: Provide the API layer for execution operations - downloading backups, deleting duplicates, and consolidating metadata.
Output: Three new async methods on ImmichClient: `download_asset()`, `delete_assets()`, `update_asset_metadata()`.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-execution-stage/05-RESEARCH.md

**Prior decisions affecting this phase:**
- 30-second timeout configured in client (Phase 01-02) - may need override for large downloads
- url::Url type for URL manipulation (Phase 01-02)
- Error handling via ImmichError enum (Phase 01-01)

**Research findings to apply:**
- Use `GET /api/assets/{id}/original` for downloads (not deprecated POST endpoint)
- Use `DELETE /api/assets` with `ids[]` for bulk delete
- Use `PUT /api/assets/{id}` for metadata consolidation
- Stream downloads with `bytes_stream()` - don't buffer in memory
- Return bytes downloaded for progress tracking

@src/client.rs
@src/error.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add download_asset method with streaming</name>
  <files>src/client.rs</files>
  <action>
Add `download_asset` method to ImmichClient:
- Signature: `pub async fn download_asset(&self, asset_id: &str, path: &Path) -> Result<u64>`
- Endpoint: `GET /api/assets/{asset_id}/original`
- Stream response bytes directly to file using `bytes_stream()` and `tokio::fs::File`
- Return total bytes written
- Handle non-success status codes with ImmichError::Api
- Add required imports: `std::path::Path`, `tokio::io::AsyncWriteExt`, `futures::StreamExt`
- Update Cargo.toml: add `futures = "0.3"` dependency
  </action>
  <verify>cargo build --lib succeeds with no errors</verify>
  <done>download_asset method compiles, streams to file, returns byte count</done>
</task>

<task type="auto">
  <name>Task 2: Add delete_assets bulk method</name>
  <files>src/client.rs</files>
  <action>
Add `delete_assets` method to ImmichClient:
- Signature: `pub async fn delete_assets(&self, asset_ids: &[String], force: bool) -> Result<()>`
- Endpoint: `DELETE /api/assets`
- Body: JSON with `ids` array and `force` boolean
- Success: 204 No Content
- Use internal struct for serialization: `struct DeleteRequest { ids, force }`
- Apply `#[serde(rename_all = "camelCase")]` for API compatibility
  </action>
  <verify>cargo build --lib succeeds</verify>
  <done>delete_assets method compiles, sends bulk delete request</done>
</task>

<task type="auto">
  <name>Task 3: Add update_asset_metadata method</name>
  <files>src/client.rs</files>
  <action>
Add `update_asset_metadata` method for metadata consolidation:
- Signature: `pub async fn update_asset_metadata(&self, asset_id: &str, latitude: Option<f64>, longitude: Option<f64>, date_time_original: Option<&str>, description: Option<&str>) -> Result<()>`
- Endpoint: `PUT /api/assets/{asset_id}`
- Body: JSON with optional fields (skip_serializing_if = "Option::is_none")
- Use `#[serde(rename_all = "camelCase")]` for field names
- Success: 200 OK
- This enables copying GPS/description from losers to winners before deletion
  </action>
  <verify>cargo clippy -- -D warnings passes</verify>
  <done>update_asset_metadata method compiles, sends PUT with optional fields</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build --lib` succeeds
- [ ] `cargo clippy -- -D warnings` passes
- [ ] `cargo test` passes (existing tests still work)
- [ ] All three methods have proper doc comments
- [ ] futures dependency added to Cargo.toml
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- ImmichClient has download_asset, delete_assets, update_asset_metadata methods
- Streaming download pattern used (no in-memory buffering)
- Ready for executor module to use these methods
</success_criteria>

<output>
After completion, create `.planning/phases/05-execution-stage/05-01-SUMMARY.md`:

# Phase 5 Plan 1: API Client Extensions Summary

**[One-liner describing what was built]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `src/client.rs` - Added download/delete/update methods
- `Cargo.toml` - Added futures dependency

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 05-02-PLAN.md (Executor Module)
</output>
