---
phase: 05-execution-stage
plan: 03
type: execute
---

<objective>
Add the execute subcommand to the CLI that consumes analysis JSON and performs downloads/deletes.

Purpose: Complete the two-stage workflow by allowing users to review analysis JSON, then execute with backups.
Output: Working `execute` subcommand that reads analysis JSON, downloads loser assets, and deletes them from Immich.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-execution-stage/05-RESEARCH.md
@.planning/phases/05-execution-stage/05-01-SUMMARY.md
@.planning/phases/05-execution-stage/05-02-SUMMARY.md

**Prior decisions affecting this phase:**
- CLI uses clap with env feature for IMMICH_URL and IMMICH_API_KEY (Phase 01-01)
- Analysis outputs AnalysisReport with groups: Vec<DuplicateAnalysis> (Phase 04-01)
- Default to trash (force=false), allow --force flag for permanent delete (Research)

**Research findings to apply:**
- Default rate limit: 10 req/sec, 5 concurrent
- Check disk space before downloading (pitfall avoidance)
- Write results as they complete for crash recovery
- Two-phase: download all, then delete only successful downloads

@src/bin/immich-dupes.rs
@src/executor.rs
@src/models/execution.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add execute subcommand to CLI</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
Extend the CLI with execute subcommand:

1. Add to Commands enum:
```rust
Execute {
    /// Path to analysis JSON from analyze command
    #[arg(short, long)]
    input: PathBuf,

    /// Directory to download backup files to
    #[arg(short, long)]
    backup_dir: PathBuf,

    /// Permanently delete instead of moving to trash
    #[arg(long, default_value = "false")]
    force: bool,

    /// Max requests per second (default: 10)
    #[arg(long, default_value = "10")]
    rate_limit: u32,

    /// Max concurrent operations (default: 5)
    #[arg(long, default_value = "5")]
    concurrent: usize,

    /// Skip groups that need manual review
    #[arg(long, default_value = "false")]
    skip_review: bool,
}
```

2. Add match arm in main() to call run_execute()

3. Implement run_execute() function:
   - Read and parse analysis JSON
   - Validate backup_dir exists (create if not)
   - Filter groups based on skip_review flag
   - Create ExecutionConfig
   - Create Executor with ImmichClient
   - Call executor.execute_all()
   - Print summary report
   - Write execution report to backup_dir/execution-report.json
  </action>
  <verify>cargo build --bin immich-dupes succeeds</verify>
  <done>Execute subcommand compiles with all options</done>
</task>

<task type="auto">
  <name>Task 2: Implement execution summary and reporting</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
Add execution output and reporting:

1. Before execution, print summary:
   - Total groups to process
   - Total assets to download
   - Estimated disk space needed (if available from file_size)
   - Backup directory path
   - Force delete: yes/no

2. During execution:
   - Progress bar shows groups completed / total
   - Current group shows download progress

3. After execution, print report:
   - Groups processed: X
   - Assets downloaded: X
   - Assets deleted: X
   - Failed operations: X (list first 5 errors)
   - Skipped (review needed): X

4. Write full ExecutionReport to backup_dir/execution-report-{timestamp}.json

5. Add confirmation prompt before starting:
   - "About to download X assets and delete them from Immich."
   - "Backups will be saved to: {path}"
   - "Continue? [y/N]"
   - Skip prompt with --yes flag
  </action>
  <verify>cargo clippy -- -D warnings passes</verify>
  <done>Execution has clear progress, summary output, and confirmation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete execute subcommand with download/delete pipeline</what-built>
  <how-to-verify>
    1. Run analysis first (if not already done):
       ./target/debug/immich-dupes -u $IMMICH_URL -k $IMMICH_API_KEY analyze -o test-analysis.json

    2. Create backup directory:
       mkdir -p /tmp/immich-backup-test

    3. Run execute in dry-run style (small test):
       ./target/debug/immich-dupes -u $IMMICH_URL -k $IMMICH_API_KEY execute \
         --input test-analysis.json \
         --backup-dir /tmp/immich-backup-test \
         --skip-review

    4. Verify:
       - Confirmation prompt appears before execution
       - Progress bar shows download/delete progress
       - Backup files appear in /tmp/immich-backup-test/
       - Execution report JSON created
       - Summary printed at end

    5. Check a few downloaded files exist and are valid images/videos

    6. Verify deleted assets are in Immich trash (not permanently deleted unless --force)
  </how-to-verify>
  <resume-signal>Type "approved" if execution works correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds (lib and bin)
- [ ] `cargo clippy -- -D warnings` passes
- [ ] `cargo test` passes
- [ ] Execute subcommand has --input, --backup-dir, --force, --rate-limit, --concurrent flags
- [ ] Confirmation prompt before destructive operations
- [ ] Progress bar during execution
- [ ] Summary report at completion
- [ ] Human verification of actual execution passed
</verification>

<success_criteria>
- All tasks completed including human verification
- Execute subcommand works end-to-end
- Downloads backups before deleting
- Respects rate limits
- Graceful error handling
- Clear progress and reporting
- Phase 5 complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-execution-stage/05-03-SUMMARY.md`:

# Phase 5 Plan 3: Execute CLI Command Summary

**[One-liner describing what was built]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `src/bin/immich-dupes.rs` - Added execute subcommand

## Decisions Made
[Key decisions and rationale]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Phase 5 complete. Project ready for use.
</output>
