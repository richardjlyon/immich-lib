---
phase: 11-configuration-ux
plan: 02
type: execute
---

<objective>
Add interactive setup prompts and credential persistence flow.

Purpose: Provide smooth first-run experience - prompt for credentials when missing and offer to save them.
Output: Interactive prompts using dialoguer, `--save` flag for credential persistence, complete configuration UX.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-configuration-ux/11-01-SUMMARY.md

**Dependencies from 11-01:**
- Config module at `src/bin/config.rs` with load/save functions
- `directories` and `toml` crates added

**Discovery findings:**
- `dialoguer` crate: Well-established (41M+ downloads), simple API
- Key prompts needed: `Input` for URL, `Password` for API key, `Confirm` for save
- Use `ColorfulTheme` for nice terminal styling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dialoguer dependency</name>
  <files>Cargo.toml</files>
  <action>
Add to Binary dependencies section:
- `dialoguer = "0.11"` - for interactive terminal prompts

Note: dialoguer uses crossterm internally which is cross-platform.
  </action>
  <verify>`cargo check` succeeds</verify>
  <done>dialoguer dependency added, project compiles</done>
</task>

<task type="auto">
  <name>Task 2: Implement interactive credential prompts</name>
  <files>src/bin/config.rs</files>
  <action>
Add to config module:

1. **prompt_credentials() function**: Returns `Result<(String, String), anyhow::Error>`
```rust
use dialoguer::{theme::ColorfulTheme, Input, Password};

pub fn prompt_credentials() -> Result<(String, String), anyhow::Error> {
    let theme = ColorfulTheme::default();

    println!();
    println!("Immich server credentials not found.");
    println!("Please enter your server details:");
    println!();

    let url: String = Input::with_theme(&theme)
        .with_prompt("Immich server URL")
        .validate_with(|input: &String| {
            if input.starts_with("http://") || input.starts_with("https://") {
                Ok(())
            } else {
                Err("URL must start with http:// or https://")
            }
        })
        .interact_text()?;

    let api_key: String = Password::with_theme(&theme)
        .with_prompt("API key")
        .interact()?;

    Ok((url, api_key))
}
```

2. **prompt_save() function**: Returns `bool`
```rust
use dialoguer::Confirm;

pub fn prompt_save(config_path: &std::path::Path) -> bool {
    println!();
    Confirm::with_theme(&ColorfulTheme::default())
        .with_prompt(format!("Save credentials to {}?", config_path.display()))
        .default(true)
        .interact()
        .unwrap_or(false)
}
```

Note: Password input hides characters as typed (security).
  </action>
  <verify>`cargo check` succeeds, `cargo clippy -- -D warnings` passes</verify>
  <done>Prompt functions implemented, compile clean</done>
</task>

<task type="auto">
  <name>Task 3: Add --save flag and integrate prompts into CLI</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
1. Add global `--save` flag to Args struct:
```rust
/// Save credentials to config file after successful connection
#[arg(long, global = true)]
save: bool,
```

2. Update `resolve_credentials` to return whether prompting occurred:
```rust
fn resolve_credentials(
    cli_url: Option<&str>,
    cli_api_key: Option<&str>,
    config: &config::Config,
) -> Result<(String, String, bool), anyhow::Error> {
    // Try CLI/env first
    if let (Some(url), Some(key)) = (cli_url, cli_api_key) {
        return Ok((url.to_string(), key.to_string(), false));
    }

    // Try config file
    if let (Some(url), Some(key)) = (&config.server.url, &config.server.api_key) {
        return Ok((url.clone(), key.clone(), false));
    }

    // Prompt interactively
    let (url, key) = config::prompt_credentials()?;
    Ok((url, key, true))
}
```

3. After successful API call (e.g., after `client.get_duplicates()` in analyze):
```rust
// If credentials were prompted or --save flag, offer to save
if prompted || args.save {
    let config_path = config::config_path();
    if config::prompt_save(&config_path) {
        let mut new_config = config.clone();
        new_config.server.url = Some(url.clone());
        new_config.server.api_key = Some(api_key.clone());
        config::save(&new_config)?;
        println!("Credentials saved to {}", config_path.display());
    }
}
```

4. Apply save logic to first command in session that connects (analyze, execute, verify, etc.)
   - Only prompt to save once per session
   - Use a flag to track if already saved this session

5. For commands that don't need credentials (generate-fixtures), skip prompting entirely.
  </action>
  <verify>`cargo clippy -- -D warnings` passes, `cargo build --release` succeeds</verify>
  <done>--save flag added, interactive prompts integrated, credential flow complete</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Interactive configuration UX with prompts and credential persistence</what-built>
  <how-to-verify>
    1. Build: `cargo build --release`
    2. Remove any existing config: `rm -rf ~/Library/Application\ Support/immich-dupes/` (macOS) or `~/.config/immich-dupes/` (Linux)
    3. Run without credentials: `./target/release/immich-dupes analyze -o /tmp/test.json`
    4. Verify: Should prompt for URL and API key interactively
    5. Enter valid credentials when prompted
    6. Verify: Should ask "Save credentials to {path}?"
    7. Say yes, verify config file created
    8. Run same command again - should NOT prompt (uses saved config)
    9. Test --save flag: `./target/release/immich-dupes --save -u "http://test" -k "testkey" analyze -o /tmp/test.json`
       - Should offer to save even though CLI args provided
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo clippy -- -D warnings` passes
- [ ] `cargo build --release` succeeds
- [ ] `cargo test` passes
- [ ] Interactive prompts work when credentials missing
- [ ] --save flag works
- [ ] Config file persists across runs
</verification>

<success_criteria>
- Interactive prompts appear when URL/API key not provided
- Password input is hidden
- User can save credentials to config file
- Subsequent runs use saved credentials without prompting
- --save flag forces save prompt even with CLI args
- All clippy checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-configuration-ux/11-02-SUMMARY.md`

Phase 11 complete after this plan.
</output>
