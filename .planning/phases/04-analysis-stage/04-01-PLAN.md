---
phase: 04-analysis-stage
plan: 01
type: execute
---

<objective>
Build the analyze CLI command that fetches duplicates, scores them by metadata completeness, and outputs results to JSON.

Purpose: Enable automated analysis of 2000+ duplicates with reviewable JSON output before any deletions occur.
Output: Working `immich-dupes analyze` command that produces a JSON file with all scored duplicate groups.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- Two-stage workflow: analyze produces JSON, execute consumes it (PROJECT.md)
- All scoring types already have Serde Serialize (Phase 3)
- CLI skeleton with clap already exists (Phase 1)

**Relevant source files:**
@src/lib.rs
@src/client.rs
@src/scoring.rs
@src/bin/immich-dupes.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand CLI with analyze subcommand</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
    Replace current flat Args struct with subcommand structure:
    1. Create Commands enum with Analyze variant
    2. Analyze subcommand takes: --output/-o (required PathBuf for JSON output)
    3. Keep url and api_key as global args (before subcommand)
    4. Make url and api_key required (not Option) - fail early if missing
    5. Add tokio::main for async support

    Structure:
    ```
    immich-dupes --url URL --api-key KEY analyze --output analysis.json
    ```

    Use clap's derive macro with #[command(subcommand)] pattern.
  </action>
  <verify>cargo build --bin immich-dupes compiles without errors</verify>
  <done>CLI accepts `analyze --output FILE` subcommand with required url/api-key global args</done>
</task>

<task type="auto">
  <name>Task 2: Implement analyze command logic</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
    Implement the analyze command:
    1. Create ImmichClient from url and api_key args
    2. Call client.get_duplicates() to fetch all duplicate groups
    3. Map each DuplicateGroup through DuplicateAnalysis::from_group()
    4. Create wrapper struct AnalysisReport with:
       - generated_at: chrono::Utc::now() ISO timestamp
       - server_url: the Immich URL used
       - total_groups: count
       - total_assets: sum of all assets across groups
       - needs_review_count: groups with conflicts
       - groups: Vec<DuplicateAnalysis>
    5. Serialize to JSON with serde_json::to_writer_pretty()
    6. Write to output file path

    Add dependencies to Cargo.toml if needed: chrono (with serde feature).

    Handle errors with anyhow for the binary (library uses thiserror).
    Print success message with output file path.
  </action>
  <verify>cargo build --bin immich-dupes compiles; cargo clippy -- -D warnings passes</verify>
  <done>Analyze command fetches duplicates, scores them, writes JSON to specified output file</done>
</task>

<task type="auto">
  <name>Task 3: Add human-readable summary output</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
    After writing JSON, print a summary to stdout:
    ```
    Analysis complete!

    Duplicate groups: 127
    Total assets: 289
    Groups needing review: 12 (have metadata conflicts)

    Output written to: analysis.json
    ```

    Use simple println! formatting - no need for fancy TUI libraries yet.
    If needs_review_count > 0, mention that these groups have conflicting metadata.
  </action>
  <verify>cargo build --bin immich-dupes compiles; cargo clippy -- -D warnings passes</verify>
  <done>CLI prints summary statistics after analysis completes</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cargo build --bin immich-dupes` succeeds
- [ ] `cargo clippy -- -D warnings` passes with no warnings
- [ ] `cargo test` passes (existing tests still work)
- [ ] `immich-dupes --help` shows analyze subcommand
- [ ] `immich-dupes analyze --help` shows --output option
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- CLI can be invoked with `immich-dupes --url URL --api-key KEY analyze --output FILE`
- Running against a real Immich server would produce valid JSON output
</success_criteria>

<output>
After completion, create `.planning/phases/04-analysis-stage/04-01-SUMMARY.md`:

# Phase 4 Plan 01: Analyze Command Summary

**[Substantive one-liner describing what shipped]**

## Performance

- **Duration:** X min
- **Started:** YYYY-MM-DDTHH:MM:SSZ
- **Completed:** YYYY-MM-DDTHH:MM:SSZ
- **Tasks:** 3
- **Files modified:** N

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Deviations from Plan

[Any changes from the plan, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete, ready for Phase 5 (Execution Stage)

---
*Phase: 04-analysis-stage*
*Completed: YYYY-MM-DD*
</output>
