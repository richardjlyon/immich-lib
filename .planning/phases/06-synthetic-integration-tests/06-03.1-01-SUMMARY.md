# Summary: 06-03.1-01 Real Image Fixture Refactor

## Objective

Refactor test fixture generation from synthetic solid-color images to real photo transformations for CLIP-based duplicate detection compatibility.

## What Was Done

### 1. Downloaded Base Images
- Acquired 10 open-license photos from Unsplash covering diverse subjects
- Stored in `tests/fixtures/base/` with ATTRIBUTION.md
- Categories: landscape, urban, portrait, food, animal, night, macro, abstract, indoor, outdoor

### 2. Refactored Generator (src/testing/generator.rs)
- Replaced solid-color generation with transform-based approach
- `TransformSpec` builder: `.with_scale()`, `.with_size()`, `.with_quality()`, `.without_dimensions()`
- Uses `image` crate with Lanczos3 filter for high-quality resizing
- EXIF metadata applied via exiftool CLI
- Video generation via ffmpeg (libx264)
- Graceful errors for unsupported formats (HEIC, RAW)

### 3. Updated Fixture Definitions (src/testing/fixtures.rs)
- All 34 scenarios rewritten to use TransformSpec
- Each duplicate group uses same base image with different transforms
- Ensures CLIP sees them as semantically similar (actual duplicates)

### 4. Regenerated All Fixtures
- 32 successful, 2 expected failures (HEIC/RAW encoding)
- Verified with exiftool spot-checks

## Verification Results

| Category | Tested | Result |
|----------|--------|--------|
| Dimension scaling (W1-W8) | Scale percentages, aspect ratios | All correct |
| EXIF stripping (W4-W6) | ExifImageWidth/Height removal | Working |
| GPS metadata (C1, F1-F2) | Coordinates, conflicts | Correct coords |
| DateTime (C2, X10-X11) | Old/future dates | 1985, 2030 verified |
| Timezone (F3) | UTC vs PST | +00:00 vs -08:00 |
| Camera info (F4) | Make/Model conflicts | Canon vs Nikon |
| Description (C3, X9) | Unicode, emoji | Japanese text preserved |
| Video (X5) | HD vs SD | 1920x1080 vs 640x480 |

## Files Modified

- `src/testing/generator.rs` - Complete rewrite for transform-based generation
- `src/testing/fixtures.rs` - All 34 fixtures updated to new API
- `src/testing/mod.rs` - Updated exports (TransformSpec replaces ImageSpec)
- `src/bin/immich-dupes.rs` - Added base_dir parameter to generate_image call
- `tests/fixtures/base/` - 10 new base images + ATTRIBUTION.md
- `tests/fixtures/*/` - 32 regenerated test images

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Transform-only approach | User preference: simpler than dual-mode |
| Lanczos3 filter | High-quality resizing for realistic test images |
| Same base per group | Ensures CLIP semantic similarity for duplicate detection |
| Percentage scaling | Intuitive API: `.with_scale(50)` for half-size |

## Issues Encountered

1. **base_outdoor.jpg was PNG**: Unsplash served PNG with .jpg extension, re-downloaded different photo
2. **HEIC/RAW unsupported**: Expected - require proprietary encoders, return explicit error

## Metrics

- Duration: ~25 min
- Files changed: 6
- Fixtures generated: 32/34 (2 expected failures)
