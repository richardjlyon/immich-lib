---
phase: 06-synthetic-integration-tests
plan: 01
type: execute
---

<objective>
Create the test image generator core module with image creation and EXIF writing capabilities.

Purpose: Establish the foundation for generating synthetic test images with precisely controlled metadata for all 34 test scenarios.
Output: Generator module with image creation, EXIF writing, and fixture specification types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-synthetic-integration-tests/COVERAGE.md

**Prior decisions:**
- ExifTool crate wraps Phil Harvey's exiftool CLI (requires system install)
- image crate for creating images with specific dimensions
- All 34 scenarios get synthetic fixtures for reproducibility

**Libraries verified via Context7:**
- `image` crate: Create RGB images, save as JPEG/PNG
- `exiftool` crate: Write EXIF tags via `write_tag()` method

@src/testing/mod.rs
@src/testing/scenarios.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add generator dependencies</name>
  <files>Cargo.toml</files>
  <action>
Add dependencies for image generation and EXIF manipulation:
- `image = "0.25"` - image creation and encoding
- `exiftool = "0.3"` - EXIF writing via ExifTool CLI wrapper
- `tempfile = "3"` - temporary file handling for tests

Add these under [dev-dependencies] since they're only needed for test fixture generation, not the library itself.
  </action>
  <verify>cargo check succeeds with new dependencies</verify>
  <done>Dependencies added, cargo check passes</done>
</task>

<task type="auto">
  <name>Task 2: Create generator module</name>
  <files>src/testing/generator.rs, src/testing/mod.rs</files>
  <action>
Create `src/testing/generator.rs` with:

1. `ImageSpec` struct defining image properties:
   - width: Option<u32> (None = strip dimension EXIF)
   - height: Option<u32>
   - color: [u8; 3] (RGB fill color for visual distinction)

2. `ExifSpec` struct defining metadata:
   - gps: Option<(f64, f64)> (lat, lon)
   - datetime: Option<DateTime<Utc>>
   - timezone: Option<String>
   - camera_make: Option<String>
   - camera_model: Option<String>
   - description: Option<String>

3. `TestImage` struct combining both:
   - filename: String
   - image_spec: ImageSpec
   - exif_spec: ExifSpec

4. `generate_image(spec: &TestImage, output_dir: &Path) -> Result<PathBuf>`:
   - Create image with specified dimensions using `image` crate
   - Save as JPEG
   - Apply EXIF using `exiftool` crate
   - If dimensions are None, strip EXIF dimensions after creation
   - Return path to generated file

5. `generate_video(filename: &str, output_dir: &Path) -> Result<PathBuf>`:
   - Shell out to ffmpeg to create minimal test video
   - `ffmpeg -f lavfi -i color=c=blue:s=320x240:d=1 -c:v libx264 output.mp4`
   - Return path to generated file

Export module from testing/mod.rs.
  </action>
  <verify>cargo check passes, module compiles</verify>
  <done>Generator module created with ImageSpec, ExifSpec, TestImage, generate_image, generate_video functions</done>
</task>

<task type="auto">
  <name>Task 3: Define fixture specifications</name>
  <files>src/testing/fixtures.rs, src/testing/mod.rs</files>
  <action>
Create `src/testing/fixtures.rs` with:

1. `ScenarioFixture` struct:
   - scenario: TestScenario
   - images: Vec<TestImage> (the set of images forming a duplicate group)
   - expected_winner_index: usize (which image should win)
   - description: String

2. `fn all_fixtures() -> Vec<ScenarioFixture>`:
   Return fixture definitions for all 34 scenarios. Each fixture specifies:
   - The images in the duplicate group
   - Their dimensions (or None for missing)
   - Their EXIF metadata
   - Which one should be selected as winner

   Example for W1 (clear dimension winner):
   ```rust
   ScenarioFixture {
       scenario: TestScenario::W1ClearDimensionWinner,
       images: vec![
           TestImage {
               filename: "w1_large.jpg".into(),
               image_spec: ImageSpec { width: Some(2000), height: Some(1500), color: [255, 0, 0] },
               exif_spec: ExifSpec::default(),
           },
           TestImage {
               filename: "w1_small.jpg".into(),
               image_spec: ImageSpec { width: Some(1000), height: Some(750), color: [255, 0, 0] },
               exif_spec: ExifSpec::default(),
           },
       ],
       expected_winner_index: 0, // larger dimensions wins
       description: "Larger image should win".into(),
   }
   ```

   Define all 34 fixtures with appropriate test data:
   - W1-W8: Dimension variations
   - C1-C8: Metadata consolidation scenarios
   - F1-F7: Conflict scenarios (GPS, timezone, camera, etc.)
   - X1-X11: Edge cases (video, unicode, large groups, etc.)

   Use distinct colors for each scenario so generated images are visually identifiable.

Export module from testing/mod.rs.
  </action>
  <verify>cargo check passes, all 34 scenarios have fixture definitions</verify>
  <done>Fixture specifications defined for all 34 scenarios</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo check` passes
- [ ] `cargo clippy -- -D warnings` passes
- [ ] Generator module exports: ImageSpec, ExifSpec, TestImage, generate_image, generate_video
- [ ] Fixtures module exports: ScenarioFixture, all_fixtures()
- [ ] all_fixtures() returns exactly 34 fixtures (one per TestScenario)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Generator foundation ready for fixture generation in 06-03-02
</success_criteria>

<output>
After completion, create `.planning/phases/06-synthetic-integration-tests/06-03-01-SUMMARY.md`
</output>
