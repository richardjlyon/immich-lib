---
phase: 06-synthetic-integration-tests
plan: 02
type: execute
---

<objective>
Implement winner selection and consolidation integration tests.

Purpose: Verify the scoring algorithm correctly selects winners based on dimensions and consolidation works.
Output: Integration tests for W1-W8 (winner selection) and C1-C8 (consolidation) scenarios.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-synthetic-integration-tests/06-05-01-SUMMARY.md
@tests/fixtures/MANIFEST.md

**Prior decisions:**
- Winner = largest dimensions (05-04)
- GPS conflict threshold 0.0001 deg (03-01)

**Test scenarios:**
- W1-W8: Winner selection by dimensions
- C1-C8: Metadata consolidation from losers to winner
</context>

<tasks>

<task type="auto">
  <name>Task 1: Winner selection tests (W1-W8)</name>
  <files>tests/integration/winner_tests.rs</files>
  <action>
Create integration tests for winner selection scenarios:

1. Create `winner_tests.rs` with:
   - `#[ignore]` attribute on all tests (require explicit --ignored flag)
   - Single test function `test_winner_selection()` that:
     - Calls harness.setup() once
     - Calls harness.wait_for_duplicates()
     - Creates ImmichClient with API key
     - Fetches and scores duplicate groups
     - For each W scenario (w1-w8):
       - Load manifest
       - Find matching duplicate group
       - Assert winner matches expected_winner
     - Calls harness.teardown() at end

2. Use `#[test]` with `#[ignore]` so tests don't run by default
   - Run with: `cargo test --test integration -- --ignored`

3. Handle missing scenarios gracefully:
   - If a scenario's duplicate group isn't found, log warning but don't fail
   - Immich may not detect all synthetic pairs as duplicates

4. Test logic flow:
   ```rust
   let harness = TestHarness::setup()?;
   let duplicates = harness.wait_for_duplicates()?;
   let client = ImmichClient::new(&harness.base_url, &harness.api_key)?;
   let scored = score_duplicate_groups(&duplicates);

   for code in ["w1", "w2", "w3", "w4", "w5", "w6", "w7", "w8"] {
       let manifest = load_manifest(code);
       if let Some(group) = find_scenario_group(&scored, &manifest) {
           assert_winner_matches(group, &manifest.expected_winner);
       } else {
           eprintln!("Warning: {} not found in duplicates", code);
       }
   }

   harness.teardown();
   ```

Note: Use blocking reqwest client in tests for simplicity.
  </action>
  <verify>cargo test --test integration -- --ignored runs without panic (may have warnings for missing groups)</verify>
  <done>W1-W8 winner selection tests pass or warn appropriately</done>
</task>

<task type="auto">
  <name>Task 2: Consolidation tests (C1-C8)</name>
  <files>tests/integration/consolidation_tests.rs</files>
  <action>
Create integration tests for consolidation scenarios:

1. Create `consolidation_tests.rs` with:
   - Test function `test_consolidation_scenarios()`
   - Uses same harness setup pattern as winner tests
   - For each C scenario (c1-c8):
     - Load manifest
     - Find matching duplicate group
     - Assert winner matches expected_winner
     - (Future: verify consolidation recommendations in scored output)

2. C scenarios test that:
   - C1: Winner lacks GPS → loser has it (consolidation opportunity)
   - C2: Winner lacks datetime → loser has it
   - C3: Winner lacks description → loser has it
   - C4: Winner lacks all → loser has everything
   - C5: Both have same GPS (no consolidation needed)
   - C6: Multiple losers contribute different metadata
   - C7: No loser has needed metadata
   - C8: Winner already has all metadata

3. For now, just verify winner selection is correct
   - Full consolidation testing requires execute command
   - Mark consolidation verification as TODO in comments

Note: Consolidation is tested indirectly - correct winner selection is the main validation.
  </action>
  <verify>cargo test --test integration -- --ignored includes consolidation tests</verify>
  <done>C1-C8 tests integrated and passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo test --test integration -- --ignored` runs all W and C tests
- [ ] Tests either pass or warn about missing duplicate groups
- [ ] No panics from assertion failures (winner selection works)
</verification>

<success_criteria>
- Winner selection tests verify W1-W8 scenarios
- Consolidation tests verify C1-C8 scenarios
- Tests handle missing duplicate groups gracefully
- Clear output showing which scenarios passed/warned
</success_criteria>

<output>
After completion, create `.planning/phases/06-synthetic-integration-tests/06-05-02-SUMMARY.md`
</output>
