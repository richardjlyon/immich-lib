---
phase: 06-synthetic-integration-tests
plan: 05.2-01
type: execute
---

<objective>
Fix test fixture isolation by providing unique base images per scenario and resolving HEIC/RAW manifest inconsistencies.

Purpose: Enable reliable integration testing where each scenario produces its own isolated duplicate group in Immich's CLIP detection.
Output: 32 unique base images, updated fixtures.rs, regenerated fixtures with no manifest errors.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-synthetic-integration-tests/06-05.2-CONTEXT.md
@.planning/phases/06-synthetic-integration-tests/06-05-02-SUMMARY.md
@.planning/phases/06-synthetic-integration-tests/06-03.1-01-SUMMARY.md

**Problem discovered in 06-05-02:**
Immich's CLIP model groups fixtures from the same base image together regardless of scenario.
Example: C1, C2, C3, C4, C5, C6 grouped into ONE duplicate group because they share base images.

**Current base image reuse:**
- `base_landscape.jpg` - W1, W2, W3, X9, X10, X11
- `base_urban.jpg` - W4, W5, W6
- `base_portrait.jpg` - W7, W8
- `base_food.jpg` - C1, C2, C3
- `base_animal.jpg` - C4, C5, C6
- `base_night.jpg` - C7, C8
- `base_macro.jpg` - F1, F2, F3
- `base_abstract.jpg` - F4, F5, F6
- `base_indoor.jpg` - F7, X1, X2, X4
- `base_outdoor.jpg` - X3, X5, X6, X7, X8

**HEIC/RAW issue:**
X6 (HEIC) and X8 (RAW) are defined in fixtures.rs but generator returns explicit errors for these formats. This creates manifest inconsistencies where tests expect files that don't exist.

**Solution:**
1. Remove X6/X8 from fixtures (can't generate valid HEIC/RAW without proprietary encoders)
2. Source 32 unique Unsplash photos (one per remaining scenario)
3. Update fixtures.rs to use unique base images
4. Regenerate all fixtures

@src/testing/fixtures.rs
@src/testing/scenarios.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove HEIC/RAW scenarios from fixtures</name>
  <files>src/testing/scenarios.rs, src/testing/fixtures.rs</files>
  <action>
    1. In scenarios.rs: Remove X6Heic and X8Raw from TestScenario enum
    2. Update TestScenario::all() to exclude these variants
    3. Update TestScenario::code() match arms
    4. In fixtures.rs: Remove x6_heic() and x8_raw() functions
    5. Remove X6 and X8 from all_fixtures() vec
    6. Update test_all_fixtures_count() to expect 32 instead of 34

    This eliminates manifest inconsistencies since these formats can't be generated.
  </action>
  <verify>cargo build && cargo test --lib -- fixtures::tests</verify>
  <done>X6/X8 removed, fixtures count is 32, all lib tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Download 32 unique Unsplash photos</name>
  <files>tests/fixtures/base/*.jpg, tests/fixtures/base/ATTRIBUTION.md</files>
  <action>
    Download 32 unique photos from Unsplash (one per scenario). Use diverse subjects to maximize CLIP differentiation:

    Naming convention: `base_{scenario_code}.jpg` (e.g., base_w1.jpg, base_c1.jpg)

    Categories to ensure diversity:
    - W1-W8: landscapes, cityscapes, nature (8 photos)
    - C1-C8: food, animals, people, objects (8 photos)
    - F1-F7: architecture, textures, patterns (7 photos)
    - X1-X5, X7, X9-X11: varied subjects (9 photos) - note: X6/X8 removed

    Use curl to download from Unsplash source URLs (600x400 size for consistency).
    Update ATTRIBUTION.md with new photo credits.

    Remove old base_*.jpg files (base_landscape.jpg, base_urban.jpg, etc.) after new ones downloaded.
  </action>
  <verify>ls tests/fixtures/base/*.jpg | wc -l shows 32 files</verify>
  <done>32 unique base images downloaded, old shared images removed, ATTRIBUTION.md updated</done>
</task>

<task type="auto">
  <name>Task 3: Update fixtures.rs with unique base images</name>
  <files>src/testing/fixtures.rs</files>
  <action>
    Update each scenario function to use its own unique base image:

    - w1_clear_dimension_winner(): TransformSpec::new("base_w1.jpg")
    - w2_same_dimensions_different_size(): TransformSpec::new("base_w2.jpg")
    - ... (all 32 scenarios)

    Each scenario's images should ALL use the SAME base (e.g., w1_large.jpg and w1_small.jpg both use base_w1.jpg).
    This ensures CLIP sees them as duplicates within a scenario but NOT across scenarios.

    Pattern per scenario:
    - Winner image: TransformSpec::new("base_{code}.jpg").with_scale(100)
    - Loser image(s): TransformSpec::new("base_{code}.jpg").with_scale(50) or other transforms
  </action>
  <verify>cargo build && cargo test --lib -- fixtures::tests</verify>
  <done>All 32 fixtures use unique base images, lib tests pass</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Regenerated all test fixtures with unique base images per scenario</what-built>
  <how-to-verify>
    1. Regenerate fixtures:
       ```
       cargo build && ./target/debug/immich-dupes generate-fixtures
       ```
    2. Verify 32 scenario directories created (no X6/X8):
       ```
       ls tests/fixtures/ | grep -E '^[wcfx][0-9]' | wc -l
       ```
       Should show 32 directories
    3. Spot-check a few scenarios have different base images:
       ```
       exiftool -ImageDescription tests/fixtures/w1/w1_large.jpg
       exiftool -ImageDescription tests/fixtures/c1/c1_winner_no_gps.jpg
       ```
       Or visually compare the images - they should be completely different photos
    4. Verify no manifest errors in output (no HEIC/RAW failures)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] cargo build succeeds
- [ ] cargo test --lib passes (32 fixtures expected)
- [ ] generate-fixtures runs without errors
- [ ] 32 scenario directories exist (X6/X8 removed)
- [ ] Each scenario uses unique base image (visual spot-check)
</verification>

<success_criteria>
- X6 (HEIC) and X8 (RAW) scenarios removed - no more manifest inconsistencies
- 32 unique base images downloaded to tests/fixtures/base/
- Each fixture uses its own base image (base_w1.jpg, base_c1.jpg, etc.)
- Fixtures regenerated successfully
- Ready for 06-05-03 edge case testing with proper scenario isolation
</success_criteria>

<output>
After completion, create `.planning/phases/06-synthetic-integration-tests/06-05.2-01-SUMMARY.md`:

# Phase 06 Plan 05.2-01: Unique Base Images Summary

**[Substantive one-liner about what was accomplished]**

## Performance

- **Duration:** X min
- **Started:** YYYY-MM-DDTHH:MM:SSZ
- **Completed:** YYYY-MM-DDTHH:MM:SSZ
- **Tasks:** 4
- **Files modified:** N

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file` - Description

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| ... | ... |

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for 06-05-03: Edge case tests (F1-F7, X1-X5, X7, X9-X11) with proper CLIP isolation.

---
*Phase: 06-synthetic-integration-tests*
*Completed: YYYY-MM-DD*
</output>
