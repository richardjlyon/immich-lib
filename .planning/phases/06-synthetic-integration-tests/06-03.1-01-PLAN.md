---
phase: 06-synthetic-integration-tests
plan: 03.1-01
type: execute
---

<objective>
Refactor fixture generator to use real base images with transformations for CLIP-compatible duplicate detection.

Purpose: Fix critical gap where synthetic solid-color images won't be detected as duplicates by Immich's CLIP-based ML system. Real photos with realistic transformations (resize, recompress) will trigger proper duplicate detection.
Output: Refactored generator using open-license base images, regenerated fixtures that Immich ML will recognize as duplicates.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-synthetic-integration-tests/06-03-03-SUMMARY.md
@tests/fixtures/MANIFEST.md
@src/testing/generator.rs
@src/testing/fixtures.rs

**Problem identified:**
Current generator creates solid-color rectangles with different RGB values. Immich uses CLIP embeddings for duplicate detection - semantic/visual similarity, not checksums. Solid-color images will either:
- ALL be grouped together (they're all "simple rectangles" to CLIP)
- NONE be detected as duplicates (too semantically different from real photos)

Neither validates real-world behavior.

**Solution:**
1. Download ~10 diverse open-license photos as base images
2. Create duplicate variants by transforming the SAME image
3. Apply EXIF modifications to test metadata handling

**How real duplicates occur:**
- Same photo, different compression (JPEG quality 80 vs 95)
- Same photo, different resolution (resized for sharing)
- Same photo from different sources (cloud sync duplicates)

**Prior decisions preserved:**
- Keep same 34 scenarios and fixture structure
- Keep same ExifSpec and EXIF application logic
- Keep manifest.json format for test verification
</context>

<tasks>

<task type="auto">
  <name>Task 1: Download open-license base images</name>
  <files>tests/fixtures/base/, tests/fixtures/base/ATTRIBUTION.md</files>
  <action>
Download 10 diverse base images from Unsplash (free for any use, no attribution required but we'll include it anyway):

1. Create tests/fixtures/base/ directory
2. Download images using direct Unsplash source URLs (unsplash.com/photos/{id}/download):
   - Landscape nature (mountains, ocean)
   - Urban/architecture
   - Portrait/person
   - Food/still life
   - Animals
   - Low-light/night
   - Macro/close-up
   - Abstract/textures
   - Indoor scene
   - Outdoor activity

3. Name files descriptively: base_landscape.jpg, base_portrait.jpg, etc.
4. Target resolution: ~2000-4000px on long edge (typical camera output)
5. Create ATTRIBUTION.md with photo credits and Unsplash license note

Use curl to download. Example:
```bash
curl -L "https://unsplash.com/photos/PHOTO_ID/download?force=true" -o base_landscape.jpg
```

Or use direct source URLs like:
```bash
curl -L "https://images.unsplash.com/photo-XXXXX?w=3000" -o base_landscape.jpg
```
  </action>
  <verify>ls tests/fixtures/base/*.jpg shows 10 images, each >500KB</verify>
  <done>10 diverse base images downloaded with attribution file</done>
</task>

<task type="auto">
  <name>Task 2: Refactor generator for image transformations</name>
  <files>src/testing/generator.rs</files>
  <action>
Refactor the generator to create duplicates via transformations instead of generating from scratch:

1. Add new struct for transformation-based generation:
```rust
pub struct TransformSpec {
    /// Base image to transform (path relative to fixtures/base/)
    pub base_image: String,
    /// Target width (None = keep original)
    pub target_width: Option<u32>,
    /// Target height (None = keep original, or scale proportionally)
    pub target_height: Option<u32>,
    /// JPEG quality (1-100, None = 85 default)
    pub jpeg_quality: Option<u8>,
}
```

2. Add new function `generate_from_base()`:
   - Load base image using image crate
   - Apply resize transformation if target dimensions specified
   - Save with specified JPEG quality (controls file size)
   - Apply EXIF using existing apply_exif() function

3. Keep existing generate_image() for backward compatibility but mark deprecated

4. Key transformations for scenarios:
   - W1 (dimension winner): Same base, one at 100% size, one at 50%
   - W2 (same dims, diff size): Same dimensions, JPEG quality 95 vs 75
   - C1 (GPS consolidation): Same transform, different EXIF
   - F1 (GPS conflict): Same transform, conflicting EXIF

5. Handle edge cases:
   - Video scenarios (X5): Keep ffmpeg approach, but base it on same color pattern
   - PNG scenarios (X7): Save as PNG vs JPEG from same base
   - Large file (X3): Use high-res base image at full quality
  </action>
  <verify>cargo build --lib succeeds, cargo test -p immich-lib passes</verify>
  <done>Generator can create duplicate variants from base images via transformations</done>
</task>

<task type="auto">
  <name>Task 3: Update fixture definitions for transformation-based approach</name>
  <files>src/testing/fixtures.rs</files>
  <action>
Update fixture definitions to use TransformSpec instead of ImageSpec colors:

1. Add TransformSpec to TestImage struct (or create new variant)

2. Update each scenario to specify:
   - Which base image to use (choose appropriate type for scenario)
   - Transformation parameters for each variant

3. Scenario mapping examples:

**Winner Selection (W1-W8):**
- W1: base_landscape.jpg → full size vs 50% resize
- W2: base_portrait.jpg → quality 95 vs quality 75 (same dimensions)
- W3: base_urban.jpg → quality 85 both (identical output)
- W7: base_nature.jpg → 100%, 75%, 50% for 3+ duplicates

**Consolidation (C1-C8):**
- C1: base_food.jpg → same transform, winner has no GPS, loser has GPS
- C4: base_animal.jpg → same transform, winner bare EXIF, loser rich EXIF

**Conflicts (F1-F7):**
- F1: base_indoor.jpg → same transform, GPS London vs Paris in EXIF
- F6: base_outdoor.jpg → same transform, multiple conflicting EXIF fields

**Edge Cases (X1-X11):**
- X2: base_abstract.jpg → 12 variants at different sizes
- X3: base_macro.jpg → use at full resolution (high quality)
- X5: Keep video generation (ffmpeg), use consistent parameters
- X7: base_texture.jpg → save as PNG vs JPEG

4. Assign base images to scenarios to ensure each base is used ~3-4 times
  </action>
  <verify>cargo test --lib -- fixtures passes, all 34 scenarios defined</verify>
  <done>All fixture definitions updated to use transformation-based approach</done>
</task>

<task type="auto">
  <name>Task 4: Regenerate all fixtures</name>
  <files>tests/fixtures/w1/ through tests/fixtures/x11/, tests/fixtures/MANIFEST.md</files>
  <action>
1. Clear existing generated fixtures (keep base/ directory):
```bash
cd tests/fixtures
rm -rf w1 w2 w3 w4 w5 w6 w7 w8 c1 c2 c3 c4 c5 c6 c7 c8 f1 f2 f3 f4 f5 f6 f7 x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11
```

2. Run generator:
```bash
./target/debug/immich-dupes generate-fixtures
```

3. Verify each scenario directory contains:
   - Image files (transformed from base images)
   - manifest.json with scenario metadata

4. Update MANIFEST.md to reflect new approach:
   - Note base images used
   - Document transformation strategy
   - Update any status changes

5. Spot-check with exiftool:
   - Verify EXIF is applied correctly
   - Verify dimensions match expectations
   - Verify file sizes differ where expected (different quality levels)
  </action>
  <verify>
ls tests/fixtures/*/manifest.json | wc -l shows 34
exiftool tests/fixtures/c1/*.jpg shows GPS present on loser, absent on winner
  </verify>
  <done>All 34 scenarios regenerated with real base images</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] 10 base images exist in tests/fixtures/base/
- [ ] ATTRIBUTION.md credits all base images
- [ ] `cargo build` succeeds
- [ ] `cargo test --lib` passes
- [ ] All 34 scenario directories regenerated
- [ ] Each scenario has images derived from same base (visual similarity)
- [ ] EXIF metadata applied correctly (spot-check with exiftool)
- [ ] File sizes vary appropriately for quality-based scenarios
</verification>

<success_criteria>
- Base images are real photographs with visual complexity
- Duplicate variants are visually similar (same base, different transform)
- CLIP-based detection should recognize variants as duplicates
- EXIF metadata tests still cover all 34 scenarios
- Existing test structure preserved (manifest.json format unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/06-synthetic-integration-tests/06-03.1-01-SUMMARY.md`:

# Phase 06 Plan 03.1-01: Real Image Fixture Refactor Summary

**[One-liner describing the refactor]**

## Performance

- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 4

## Accomplishments

- Downloaded 10 open-license base images
- Refactored generator for transformation-based approach
- Updated all 34 fixture definitions
- Regenerated fixtures with real image content

## Files Created/Modified

- `tests/fixtures/base/` - 10 base images + attribution
- `src/testing/generator.rs` - Transformation-based generation
- `src/testing/fixtures.rs` - Updated fixture definitions
- `tests/fixtures/*/` - Regenerated scenario directories

## Decisions Made

- [Base image selection rationale]
- [Transformation strategy for each scenario type]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for 06-04: Docker Test Environment (now with CLIP-compatible fixtures)
</output>
