---
phase: 06-synthetic-integration-tests
plan: 02
type: execute
---

<objective>
Generate synthetic test images for Winner Selection (W1-W8) and Consolidation (C1-C8) scenarios.

Purpose: Create the first 16 scenario fixtures with controlled dimensions and metadata for testing winner selection and metadata consolidation logic.
Output: Generated test images in tests/fixtures/ directory for W and C scenarios.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-synthetic-integration-tests/COVERAGE.md
@.planning/phases/06-synthetic-integration-tests/06-03-01-SUMMARY.md

**Scenarios to generate:**

Winner Selection (W1-W8):
- W1: Clear dimension winner (2000x1500 vs 1000x750)
- W2: Same dimensions, different file size (vary JPEG quality)
- W3: Same dimensions, same file size
- W4: Some assets missing dimensions
- W5: Only one has dimensions
- W6: All missing dimensions (fallback to file size)
- W7: 3+ duplicates (test multi-asset groups)
- W8: Same pixel count, different aspect (1920x1080 vs 1080x1920)

Consolidation (C1-C8):
- C1: Winner lacks GPS, loser has GPS
- C2: Winner lacks datetime, loser has datetime
- C3: Winner lacks description, loser has description
- C4: Winner lacks all, loser has all
- C5: Both have GPS (no consolidation needed)
- C6: Multiple losers contribute different fields
- C7: No loser has what winner lacks
- C8: Winner already has everything

@src/testing/generator.rs
@src/testing/fixtures.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fixture generation CLI command</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
Add `generate-fixtures` CLI command:

```rust
#[derive(Subcommand)]
enum Commands {
    // ... existing commands ...

    /// Generate synthetic test fixtures
    GenerateFixtures {
        /// Output directory for fixtures
        #[arg(long, default_value = "tests/fixtures")]
        output_dir: PathBuf,

        /// Only generate specific scenario (e.g., "W1", "C3")
        #[arg(long)]
        scenario: Option<String>,
    },
}
```

Implementation:
1. Create output directory if not exists
2. Load fixtures from all_fixtures()
3. For each fixture (or filtered by --scenario):
   - Create scenario subdirectory (e.g., tests/fixtures/w1/)
   - Call generate_image() for each TestImage in the fixture
   - Write manifest.json with expected_winner and metadata
4. Print summary of generated fixtures

This allows regenerating fixtures on demand and filtering to specific scenarios during development.
  </action>
  <verify>cargo build succeeds, `./target/debug/immich-dupes generate-fixtures --help` shows options</verify>
  <done>generate-fixtures command added with --output-dir and --scenario options</done>
</task>

<task type="auto">
  <name>Task 2: Generate W1-W8 fixtures</name>
  <files>tests/fixtures/w1/ through tests/fixtures/w8/</files>
  <action>
Run the generator for Winner Selection scenarios:

```bash
./target/debug/immich-dupes generate-fixtures --scenario W1
./target/debug/immich-dupes generate-fixtures --scenario W2
# ... through W8
```

Or generate all W scenarios:
```bash
for i in {1..8}; do ./target/debug/immich-dupes generate-fixtures --scenario W$i; done
```

Verify each scenario directory contains:
- The expected number of JPEG images
- manifest.json with scenario metadata
- Images have correct dimensions (check with exiftool or file command)

For W4/W5/W6 (missing dimensions), verify EXIF dimensions are actually stripped.
For W8, verify images have same pixel count but different aspect ratios.
  </action>
  <verify>ls tests/fixtures/w*/ shows 8 directories with images and manifests</verify>
  <done>W1-W8 fixtures generated with correct dimensions and metadata</done>
</task>

<task type="auto">
  <name>Task 3: Generate C1-C8 fixtures</name>
  <files>tests/fixtures/c1/ through tests/fixtures/c8/</files>
  <action>
Run the generator for Consolidation scenarios:

```bash
for i in {1..8}; do ./target/debug/immich-dupes generate-fixtures --scenario C$i; done
```

Verify each scenario has correct EXIF:
- C1: Winner missing GPS, loser has GPS coords (use 51.5074, -0.1278 - London)
- C2: Winner missing datetime, loser has datetime (use 2024-06-15T14:30:00Z)
- C3: Winner missing description, loser has "Test description"
- C4: Winner missing all three, loser has all three
- C5: Both have GPS (winner: London, loser: Paris 48.8566, 2.3522)
- C6: Three assets - loser1 has GPS, loser2 has description
- C7: Winner lacks GPS, losers also lack GPS (no consolidation possible)
- C8: Winner has GPS, datetime, description (complete metadata)

Use exiftool to verify EXIF tags are correctly set:
```bash
exiftool tests/fixtures/c1/*.jpg
```
  </action>
  <verify>ls tests/fixtures/c*/ shows 8 directories; exiftool confirms EXIF metadata</verify>
  <done>C1-C8 fixtures generated with correct consolidation metadata scenarios</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo clippy -- -D warnings` passes
- [ ] tests/fixtures/ contains w1-w8 and c1-c8 subdirectories (16 total)
- [ ] Each directory contains JPEG images and manifest.json
- [ ] W4/W5/W6 images have stripped dimension EXIF
- [ ] C1-C8 images have correct GPS/datetime/description as specified
- [ ] `exiftool tests/fixtures/c1/*.jpg` shows expected metadata
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- 16 scenario fixtures generated and verified
- Ready for F/X scenarios in 06-03-03
</success_criteria>

<output>
After completion, create `.planning/phases/06-synthetic-integration-tests/06-03-02-SUMMARY.md`
</output>
