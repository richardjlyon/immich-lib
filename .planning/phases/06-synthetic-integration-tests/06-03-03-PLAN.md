---
phase: 06-synthetic-integration-tests
plan: 03
type: execute
---

<objective>
Generate synthetic test images for Conflict (F1-F7) and Edge Case (X1-X11) scenarios.

Purpose: Complete the fixture generation with conflict detection scenarios and edge cases including video, unicode, and format variations.
Output: Generated test fixtures in tests/fixtures/ for F and X scenarios, completing all 34 scenarios.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-synthetic-integration-tests/COVERAGE.md
@.planning/phases/06-synthetic-integration-tests/06-03-02-SUMMARY.md

**Scenarios to generate:**

Conflicts (F1-F7):
- F1: GPS conflict (London vs Tokyo - clearly different locations)
- F2: GPS within threshold (~5m apart, should NOT conflict)
- F3: Timezone conflict (same time, different timezones)
- F4: Camera conflict (Canon vs Nikon)
- F5: Capture time conflict (different dates)
- F6: Multiple conflicts (GPS + timezone + camera)
- F7: No conflicts (identical metadata)

Edge Cases (X1-X11):
- X1: Single asset "group" (degenerate case)
- X2: Large group (12 duplicate assets)
- X3: Large file (>50MB - just create larger dimensions)
- X4: Special characters in filename (spaces, unicode, symbols)
- X5: Video duplicates (MP4 files via ffmpeg)
- X6: HEIC files (if possible, else skip - needs specific encoder)
- X7: PNG files
- X8: RAW files (skip - requires specific format encoder)
- X9: Unicode in description (emoji, CJK characters)
- X10: Very old date (1985-03-15)
- X11: Future date (2099-12-31)

@src/testing/generator.rs
@src/testing/fixtures.rs
@src/bin/immich-dupes.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate F1-F7 conflict fixtures</name>
  <files>tests/fixtures/f1/ through tests/fixtures/f7/</files>
  <action>
Generate Conflict scenario fixtures:

```bash
for i in {1..7}; do ./target/debug/immich-dupes generate-fixtures --scenario F$i; done
```

Fixture specifications:
- F1: GPS conflict
  - Image 1: London (51.5074, -0.1278)
  - Image 2: Tokyo (35.6762, 139.6503)
  - ~9,500km apart - definite conflict

- F2: GPS within threshold
  - Image 1: (51.507400, -0.127800)
  - Image 2: (51.507405, -0.127795)
  - ~0.5m apart - within 0.0001 degree threshold, NO conflict

- F3: Timezone conflict
  - Image 1: 2024-06-15T14:30:00+00:00 (UTC)
  - Image 2: 2024-06-15T14:30:00+09:00 (Tokyo)
  - Same local time, different absolute time

- F4: Camera conflict
  - Image 1: Make="Canon", Model="EOS R5"
  - Image 2: Make="Nikon", Model="Z9"

- F5: Capture time conflict
  - Image 1: 2024-06-15T14:30:00Z
  - Image 2: 2024-06-20T10:00:00Z (5 days later)

- F6: Multiple conflicts (combine F1 + F3 + F4)
  - Different GPS, different timezone, different camera

- F7: No conflicts
  - Both images: Same GPS, same datetime, same camera (or both None)

Verify with exiftool that metadata creates expected conflict conditions.
  </action>
  <verify>ls tests/fixtures/f*/ shows 7 directories; exiftool confirms conflict metadata</verify>
  <done>F1-F7 fixtures generated with correct conflict scenarios</done>
</task>

<task type="auto">
  <name>Task 2: Generate X1-X11 edge case fixtures</name>
  <files>tests/fixtures/x1/ through tests/fixtures/x11/</files>
  <action>
Generate Edge Case fixtures:

```bash
for i in {1..11}; do ./target/debug/immich-dupes generate-fixtures --scenario X$i; done
```

Fixture specifications:

- X1: Single asset group
  - Just 1 image (degenerate case - winner is the only asset)

- X2: Large group
  - 12 duplicate images with varying sizes
  - Tests batch processing and multi-asset comparison

- X3: Large file
  - Create 8000x6000 image (~48MP)
  - Will be >10MB as JPEG, tests large file handling

- X4: Special characters in filename
  - "photo (1).jpg", "caf√©_√©t√©.jpg", "Êó•Êú¨Ë™û.jpg"
  - Tests filename handling with spaces, accents, unicode

- X5: Video duplicates
  - Use generate_video() to create two MP4 files
  - Different durations or resolutions
  - Requires ffmpeg installed

- X6: HEIC files
  - Skip if HEIC encoding not available
  - Or create placeholder with note in manifest

- X7: PNG files
  - Generate as PNG instead of JPEG
  - PNG has limited EXIF support - test handling

- X8: RAW files
  - Skip - requires specific format encoder (DNG, CR2, etc.)
  - Note in manifest: "Skipped - RAW encoding not available"

- X9: Unicode description
  - Description: "Photo taken at Êù±‰∫¨„Çø„ÉØ„Éº üóº with √©mojis"
  - Tests unicode handling in EXIF description field

- X10: Very old date
  - Datetime: 1985-03-15T10:30:00Z
  - Tests handling of dates before digital cameras

- X11: Future date
  - Datetime: 2099-12-31T23:59:59Z
  - Tests invalid/future date handling
  </action>
  <verify>ls tests/fixtures/x*/ shows 11 directories (some may have skip notes)</verify>
  <done>X1-X11 fixtures generated with correct edge case configurations</done>
</task>

<task type="auto">
  <name>Task 3: Create fixture manifest and verify completeness</name>
  <files>tests/fixtures/MANIFEST.md</files>
  <action>
Create tests/fixtures/MANIFEST.md documenting all generated fixtures:

```markdown
# Test Fixtures Manifest

Generated: [date]

## Summary
- Total scenarios: 34
- Generated: [count]
- Skipped: [count] (with reasons)

## Winner Selection (W1-W8)
| Scenario | Files | Status | Notes |
|----------|-------|--------|-------|
| W1 | w1_large.jpg, w1_small.jpg | ‚úì | |
...

## Consolidation (C1-C8)
...

## Conflicts (F1-F7)
...

## Edge Cases (X1-X11)
| X6 | - | Skipped | HEIC encoding not available |
| X8 | - | Skipped | RAW encoding not available |
...

## Regeneration
Run: ./target/debug/immich-dupes generate-fixtures
```

Verify completeness:
- Count total directories: `ls -d tests/fixtures/*/ | wc -l`
- Should be 34 (or note skipped scenarios)
- Each directory should have manifest.json

Run full verification:
```bash
# Check all fixtures exist
./target/debug/immich-dupes generate-fixtures --dry-run  # if implemented
# Or manually verify
find tests/fixtures -name "manifest.json" | wc -l
```
  </action>
  <verify>MANIFEST.md created; fixture count matches expected (32-34 depending on skips)</verify>
  <done>All fixtures generated, manifest created, completeness verified</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo clippy -- -D warnings` passes
- [ ] tests/fixtures/ contains f1-f7 and x1-x11 subdirectories
- [ ] X5 contains MP4 video files (requires ffmpeg)
- [ ] X9 description contains unicode when read with exiftool
- [ ] X10/X11 have correct old/future dates
- [ ] tests/fixtures/MANIFEST.md documents all scenarios
- [ ] Total of 34 scenario directories (or documented skips for X6/X8)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- All 34 scenarios have fixtures (or documented skips)
- MANIFEST.md provides complete documentation
- Phase 06-03 complete, ready for 06-04 (Docker Test Environment)
</success_criteria>

<output>
After completion, create `.planning/phases/06-synthetic-integration-tests/06-03-03-SUMMARY.md`
</output>
