---
phase: 06-synthetic-integration-tests
plan: 01
type: feature
---

<objective>
Build a `find-test-candidates` subcommand that scans an Immich instance and categorizes duplicate groups by test scenario.

Purpose: Discover real-world patterns to inform synthetic test image generation.
Output: Report showing which test scenarios have real examples and edge cases we hadn't considered.
</objective>

<context>
@.planning/PROJECT.md
@src/scoring.rs
@src/models/exif.rs

**Test Scenarios to Detect:**

Winner Selection (W):
- W1: Clear dimension winner (different wÃ—h)
- W2: Same dimensions, different file size
- W3: Same dimensions, same file size
- W4: Some assets missing dimensions
- W5: Only one asset has dimensions
- W6: All assets missing dimensions
- W7: 3+ assets in group
- W8: Same pixel count, different aspect ratio

Consolidation (C):
- C1: Winner lacks GPS, loser has GPS
- C2: Winner lacks datetime, loser has datetime
- C3: Winner lacks description, loser has description
- C4: Winner lacks all three, loser has all
- C5: Both have GPS (no consolidation needed)
- C6: Multiple losers contribute different fields
- C7: No loser has what winner lacks
- C8: Winner already has everything

Conflicts (F):
- F1: GPS conflict (different locations)
- F2: GPS within threshold (should NOT conflict)
- F3: Timezone conflict
- F4: Camera info conflict
- F5: Capture time conflict
- F6: Multiple conflicts
- F7: No conflicts

Edge Cases (X):
- X1: Single asset "group"
- X2: Large group (10+ duplicates)
- X3: Large file (>50MB)
- X4: Special characters in filename
- X5: Video duplicates
- X6: HEIC files
- X7: PNG files (limited EXIF)
- X8: RAW files
- X9: Unicode in description
- X10: Very old date (<1990)
- X11: Future date
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define scenario detection types</name>
  <files>src/testing/mod.rs, src/testing/scenarios.rs</files>
  <action>
Create new `testing` module with scenario detection types:

```rust
// src/testing/mod.rs
pub mod scenarios;

// src/testing/scenarios.rs
#[derive(Debug, Clone, PartialEq, Eq, Hash)]
pub enum TestScenario {
    // Winner selection
    W1_ClearDimensionWinner,
    W2_SameDimensionsDifferentSize,
    W3_SameDimensionsSameSize,
    W4_SomeMissingDimensions,
    W5_OnlyOneHasDimensions,
    W6_AllMissingDimensions,
    W7_ThreePlusDuplicates,
    W8_SamePixelsDifferentAspect,

    // Consolidation
    C1_WinnerLacksGpsLoserHas,
    C2_WinnerLacksDatetimeLoserHas,
    C3_WinnerLacksDescriptionLoserHas,
    C4_WinnerLacksAllLoserHasAll,
    C5_BothHaveGps,
    C6_MultipleLosersContribute,
    C7_NoLoserHasNeeded,
    C8_WinnerHasEverything,

    // Conflicts
    F1_GpsConflict,
    F2_GpsWithinThreshold,
    F3_TimezoneConflict,
    F4_CameraConflict,
    F5_CaptureTimeConflict,
    F6_MultipleConflicts,
    F7_NoConflicts,

    // Edge cases
    X1_SingleAssetGroup,
    X2_LargeGroup,
    X3_LargeFile,
    X4_SpecialCharsFilename,
    X5_Video,
    X6_Heic,
    X7_Png,
    X8_Raw,
    X9_UnicodeDescription,
    X10_VeryOldDate,
    X11_FutureDate,
}

pub struct ScenarioMatch {
    pub scenario: TestScenario,
    pub duplicate_id: String,
    pub details: String,
}

pub struct ScenarioReport {
    pub matches: Vec<ScenarioMatch>,
    pub unmatched_scenarios: Vec<TestScenario>,
    pub unexpected_patterns: Vec<String>,
}
```
  </action>
  <verify>cargo build</verify>
  <done>Scenario types defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement scenario detection logic</name>
  <files>src/testing/detector.rs</files>
  <action>
Create detector that analyzes a DuplicateGroup and returns matching scenarios:

```rust
pub fn detect_scenarios(group: &DuplicateGroup) -> Vec<TestScenario> {
    let mut scenarios = Vec::new();

    // Check group size
    if group.assets.len() == 1 {
        scenarios.push(TestScenario::X1_SingleAssetGroup);
    }
    if group.assets.len() >= 10 {
        scenarios.push(TestScenario::X2_LargeGroup);
    }
    if group.assets.len() >= 3 {
        scenarios.push(TestScenario::W7_ThreePlusDuplicates);
    }

    // Analyze dimensions
    let dims: Vec<Option<(u32, u32)>> = group.assets.iter()
        .map(|a| a.exif_info.as_ref().and_then(|e| ...))
        .collect();
    // ... detection logic for W1-W8

    // Analyze metadata presence for C1-C8
    // Analyze conflicts for F1-F7
    // Check edge cases X3-X11

    scenarios
}
```

Include helper functions for each category.
  </action>
  <verify>cargo build</verify>
  <done>Detection logic implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add find-test-candidates CLI command</name>
  <files>src/bin/immich-dupes.rs</files>
  <action>
Add new subcommand:

```rust
#[derive(Subcommand)]
enum Commands {
    Analyze { ... },
    Execute { ... },
    FindTestCandidates {
        /// Output format (text, json)
        #[arg(long, default_value = "text")]
        format: String,

        /// Only show groups matching specific scenario
        #[arg(long)]
        scenario: Option<String>,
    },
}
```

Implementation:
1. Fetch all duplicate groups
2. Run scenario detection on each
3. Aggregate into ScenarioReport
4. Display coverage summary and examples
  </action>
  <verify>cargo build && ./target/debug/immich-dupes find-test-candidates --help</verify>
  <done>CLI command works</done>
</task>

<task type="auto">
  <name>Task 4: Format and display report</name>
  <files>src/testing/report.rs</files>
  <action>
Create report formatter:

```
=== Test Scenario Coverage Report ===

COVERED (23/35 scenarios):
  W1_ClearDimensionWinner: 142 groups
    Example: group abc123 (4000x3000 vs 2000x1500)
  W2_SameDimensionsDifferentSize: 28 groups
    Example: group def456 (4000x3000 5.2MB vs 4000x3000 3.1MB)
  ...

NOT COVERED (12/35 scenarios):
  X5_Video: 0 groups (no video duplicates found)
  X10_VeryOldDate: 0 groups
  ...

UNEXPECTED PATTERNS:
  - Group xyz789: EXIF date format "2023:01:15" (colon separator)
  - Group uvw012: GPS altitude present but lat/lon missing
  ...

=== Summary ===
Total groups analyzed: 847
Scenarios covered: 23/35 (66%)
Recommended synthetic images needed: 12
```
  </action>
  <verify>cargo clippy -- -D warnings</verify>
  <done>Report displays clearly</done>
</task>

</tasks>

<verification>
- [ ] `cargo build` succeeds
- [ ] `cargo clippy -- -D warnings` passes
- [ ] `cargo test` passes
- [ ] `./target/debug/immich-dupes find-test-candidates` runs against live Immich
- [ ] Report shows scenario coverage
- [ ] Unexpected patterns surfaced for review
</verification>

<success_criteria>
- All 35 test scenarios have detection logic
- Clear report showing which have real examples
- Unexpected patterns logged for test matrix refinement
- Ready to inform synthetic image generation
</success_criteria>

<output>
After completion, create `.planning/phases/06-synthetic-integration-tests/06-01-SUMMARY.md`
</output>
