---
phase: 09-detection
plan: 01
type: execute
---

<objective>
Build the core letterbox detection module with aspect ratio detection and pairing algorithm.

Purpose: Identify iPhone 4:3/16:9 crop pairs using timestamp + camera matching (fallback from unavailable Live Photo Video Index).
Output: `src/letterbox.rs` module with AspectRatio enum, LetterboxPair struct, and pairing logic.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-research/DISCOVERY.md

**Prior decisions affecting this phase:**
- Pairing strategy: timestamp + make + model + GPS matching (Phase 8)
- Selection: 4:3 always wins - more pixels, full scene (Phase 8)
- No pixel analysis needed - pure metadata detection (Phase 8)

**Existing patterns to follow:**
@src/scoring.rs - ScoredAsset, DuplicateAnalysis patterns
@src/models/exif.rs - ExifInfo with helper methods
@src/models/asset.rs - AssetResponse structure
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AspectRatio enum and detection function</name>
  <files>src/letterbox.rs</files>
  <action>
Create new module `src/letterbox.rs` with:

1. AspectRatio enum:
```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum AspectRatio {
    FourThree,   // 4:3 = 1.333 (full sensor)
    SixteenNine, // 16:9 = 1.778 (cropped)
}
```

2. Detection function using orientation-agnostic ratio:
```rust
pub fn detect_aspect_ratio(width: u32, height: u32) -> Option<AspectRatio>
```
- Calculate ratio as max(w,h) / min(w,h) to handle portrait/landscape
- 4:3 ratio = 1.333 with ±0.01 tolerance
- 16:9 ratio = 1.778 with ±0.01 tolerance
- Return None for other ratios

3. Add module to lib.rs exports.

Avoid: Using width/height directly without orientation normalization (portrait 3:4 is same as landscape 4:3).
  </action>
  <verify>cargo clippy -- -D warnings && cargo test letterbox</verify>
  <done>AspectRatio enum exists, detect_aspect_ratio handles both orientations, clippy passes</done>
</task>

<task type="auto">
  <name>Task 2: Create LetterboxPair and pairing algorithm</name>
  <files>src/letterbox.rs</files>
  <action>
Add pairing types and algorithm:

1. LetterboxPair struct:
```rust
#[derive(Debug, Clone, Serialize)]
pub struct LetterboxPair {
    pub keeper: AssetResponse,      // 4:3 version (more pixels)
    pub delete: AssetResponse,      // 16:9 version (cropped)
    pub timestamp: String,          // Shared capture time
    pub camera: String,             // "Apple iPhone 15 Pro Max"
}
```

2. Pairing key for grouping:
```rust
#[derive(Debug, Clone, PartialEq, Eq, Hash)]
struct PairingKey {
    timestamp_second: String,  // dateTimeOriginal truncated to second
    make: String,              // "Apple"
    model: String,             // "iPhone 15 Pro Max"
    gps_key: Option<String>,   // "lat,lon" rounded to 4 decimals (optional)
}
```

3. Core pairing function:
```rust
pub fn find_letterbox_pairs(assets: &[AssetResponse]) -> Vec<LetterboxPair>
```
- Filter to iPhone images only (make = "Apple", model contains "iPhone")
- Skip assets without dateTimeOriginal or dimensions
- Group by PairingKey
- Within each group: if exactly one 4:3 AND one 16:9, create LetterboxPair
- 4:3 = keeper, 16:9 = delete
- Skip ambiguous groups (multiple pairs at same timestamp)

Avoid: Assuming Live Photo Video Index is available (it's not exposed by API).
  </action>
  <verify>cargo clippy -- -D warnings && cargo test letterbox</verify>
  <done>LetterboxPair struct defined, find_letterbox_pairs groups and pairs correctly</done>
</task>

<task type="auto">
  <name>Task 3: Add comprehensive unit tests</name>
  <files>src/letterbox.rs</files>
  <action>
Add tests module with:

1. Aspect ratio detection tests:
   - test_detect_4_3_landscape (5712x4284 → FourThree)
   - test_detect_4_3_portrait (4284x5712 → FourThree)
   - test_detect_16_9_landscape (5712x3213 → SixteenNine)
   - test_detect_16_9_portrait (3213x5712 → SixteenNine)
   - test_detect_other_ratio (1920x1080 is 16:9, 1000x1000 is None)
   - test_detect_with_tolerance (edge cases near boundaries)

2. Pairing tests:
   - test_find_pair_basic: One 4:3 + one 16:9 same timestamp → pair found
   - test_skip_non_iphone: Android assets ignored
   - test_skip_missing_timestamp: Assets without dateTimeOriginal skipped
   - test_skip_ambiguous: Two 4:3 at same timestamp → no pair (ambiguous)
   - test_multiple_pairs: Different timestamps produce separate pairs
   - test_gps_disambiguation: Same timestamp but different GPS → separate groups

Use helper function to create mock AssetResponse with configurable EXIF.
  </action>
  <verify>cargo test letterbox -- --nocapture</verify>
  <done>All tests pass, coverage includes edge cases from DISCOVERY.md</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo clippy -- -D warnings` passes with no warnings
- [ ] `cargo test letterbox` passes all tests
- [ ] `cargo build` succeeds
- [ ] Module exported in lib.rs
</verification>

<success_criteria>
- AspectRatio enum with FourThree and SixteenNine variants
- detect_aspect_ratio handles portrait and landscape orientations
- LetterboxPair struct with keeper/delete fields
- find_letterbox_pairs correctly groups and pairs iPhone assets
- All edge cases from DISCOVERY.md covered by tests
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/09-detection/09-01-SUMMARY.md`
</output>
